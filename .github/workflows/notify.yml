name: Notify Subscribers & Social

on:
  push:
    branches: [main]
    paths:
      - "data/items.json"
      - "scripts/**"
      - ".github/workflows/notify.yml"
  pull_request:
    paths:
      - "data/items.json"
      - "scripts/**"
      - ".github/workflows/notify.yml"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "SNS 실제 게시 대신 드라이런 수행"
        required: true
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      added_count: ${{ steps.delta.outputs.added_count }}
      has_new: ${{ steps.delta.outputs.has_new }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build delta baseline
        run: |
          mkdir -p artifacts
          if git cat-file -e HEAD~1:data/items.json 2>/dev/null; then
            git show HEAD~1:data/items.json > artifacts/items.before.json
          else
            echo '{"items":[]}' > artifacts/items.before.json
          fi

      - name: Extract new items
        run: node scripts/extract-new-items.mjs --before artifacts/items.before.json --after data/items.json --output artifacts/new-items.json

      - name: Set delta outputs
        id: delta
        run: |
          COUNT=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('artifacts/new-items.json','utf8'));process.stdout.write(String(d.added_count||0));")
          echo "added_count=${COUNT}" >> "$GITHUB_OUTPUT"
          if [ "$COUNT" -gt 0 ]; then
            echo "has_new=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build digest
        if: steps.delta.outputs.has_new == 'true'
        run: node scripts/build-digest.mjs --input artifacts/new-items.json --out-dir artifacts --site-base-url "https://chanmuzi.github.io/NLP-Paper-News/"

      - name: Job summary
        if: always()
        run: |
          echo "## Notify pipeline summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- added_count: ${{ steps.delta.outputs.added_count }}" >> "$GITHUB_STEP_SUMMARY"
          if [ -f artifacts/social-draft.md ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Social draft preview" >> "$GITHUB_STEP_SUMMARY"
            head -n 40 artifacts/social-draft.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notify-artifacts
          path: artifacts/

  send_email:
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.has_new == 'true' && vars.ENABLE_EMAIL == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/download-artifact@v4
        with:
          name: notify-artifacts
          path: artifacts
      - name: Send email via Resend
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NEWSLETTER_FROM: ${{ secrets.NEWSLETTER_FROM }}
          NEWSLETTER_SUBSCRIBERS: ${{ secrets.NEWSLETTER_SUBSCRIBERS }}
        run: node scripts/send-email-resend.mjs --digest artifacts/digest.json

  post_x:
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.has_new == 'true' && vars.ENABLE_X_POST == 'true'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/download-artifact@v4
        with:
          name: notify-artifacts
          path: artifacts
      - name: Post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          X_API_BASE: ${{ vars.X_API_BASE }}
        run: |
          DRY_RUN_FLAG="--dry-run"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.dry_run }}" = "false" ]; then
            DRY_RUN_FLAG=""
          fi
          node scripts/post-x.mjs --digest artifacts/digest.json $DRY_RUN_FLAG
