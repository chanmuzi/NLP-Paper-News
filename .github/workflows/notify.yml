name: Notify & Post to X

on:
  push:
    branches: [main]
    paths:
      - "data/items.json"
      - "scripts/**"
      - ".github/workflows/notify.yml"
  pull_request:
    paths:
      - "data/items.json"
      - "scripts/**"
      - ".github/workflows/notify.yml"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "SNS 실제 게시 대신 드라이런 수행"
        required: true
        default: true
        type: boolean

permissions:
  contents: read
  actions: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      added_count: ${{ steps.delta.outputs.added_count }}
      has_new: ${{ steps.delta.outputs.has_new }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build delta baseline
        run: |
          mkdir -p artifacts
          if git cat-file -e HEAD~1:data/items.json 2>/dev/null; then
            git show HEAD~1:data/items.json > artifacts/items.before.json
          else
            echo '{"items":[]}' > artifacts/items.before.json
          fi

      - name: Extract new items
        run: node scripts/extract-new-items.mjs --before artifacts/items.before.json --after data/items.json --output artifacts/new-items.json

      - name: Set delta outputs
        id: delta
        run: |
          COUNT=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('artifacts/new-items.json','utf8'));process.stdout.write(String(d.added_count||0));")
          echo "added_count=${COUNT}" >> "$GITHUB_OUTPUT"
          if [ "$COUNT" -gt 0 ]; then
            echo "has_new=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build digest
        if: steps.delta.outputs.has_new == 'true'
        env:
          ENABLE_AI_X_COPY: ${{ vars.ENABLE_AI_X_COPY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
          OPENAI_MODEL_MAIN: ${{ vars.OPENAI_MODEL_MAIN }}
          OPENAI_MODEL_REPLY: ${{ vars.OPENAI_MODEL_REPLY }}
          OPENAI_API_BASE: ${{ vars.OPENAI_API_BASE }}
          OPENAI_X_DEBUG: ${{ vars.OPENAI_X_DEBUG }}
          X_SAFE_LIMIT: ${{ vars.X_SAFE_LIMIT }}
          X_GEN_MARGIN: ${{ vars.X_GEN_MARGIN }}
        run: node scripts/build-digest.mjs --input artifacts/new-items.json --out-dir artifacts --site-base-url "https://chanmuzi.github.io/NLP-Paper-News/"

      - name: Job summary
        if: always()
        run: |
          echo "## Notify pipeline summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- added_count: ${{ steps.delta.outputs.added_count }}" >> "$GITHUB_STEP_SUMMARY"

          if [ -f artifacts/digest.json ]; then
            node -e "
              const fs = require('fs');
              const d = JSON.parse(fs.readFileSync('artifacts/digest.json','utf8'));
              const m = d?.social?.x_thread_meta || {};
              const replies = Array.isArray(m.reply_chars) ? m.reply_chars : [];
              const maxReply = replies.length ? Math.max(...replies) : '-';
              const lines = [];
              lines.push('');
              lines.push('### X generation meta');
              lines.push('- generator: ' + (m.generator || '-'));
              lines.push('- main_model: ' + (m.main_model || '-'));
              lines.push('- reply_model: ' + (m.reply_model || '-'));
              lines.push('- safe_limit: ' + (m.safe_limit ?? '-'));
              lines.push('- hard_limit: ' + (m.hard_limit ?? '-'));
              lines.push('- main_chars: ' + (m.main_chars ?? '-'));
              lines.push('- max_reply_chars: ' + maxReply);
              if (m.attempts) lines.push('- attempts: ' + JSON.stringify(m.attempts));
              process.stdout.write(lines.join('\n'));
            " >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -f artifacts/social-draft.md ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Social draft preview" >> "$GITHUB_STEP_SUMMARY"
            head -n 40 artifacts/social-draft.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Emit X draft payload for approval UI
        if: steps.delta.outputs.has_new == 'true' && hashFiles('artifacts/digest.json') != ''
        run: |
          node -e "
            const fs = require('fs');
            const d = JSON.parse(fs.readFileSync('artifacts/digest.json','utf8'));
            const thread = d?.social?.x_thread || {};
            const meta = d?.social?.x_thread_meta || {};
            const payload = {
              generated_at: new Date().toISOString(),
              commit_sha: process.env.GITHUB_SHA || '',
              thread: {
                main: String(thread.main || ''),
                replies: Array.isArray(thread.replies) ? thread.replies.map((x) => String(x || '')) : []
              },
              meta: {
                generator: meta.generator || 'rule',
                main_model: meta.main_model || '-',
                reply_model: meta.reply_model || '-',
                safe_limit: meta.safe_limit ?? null,
                hard_limit: meta.hard_limit ?? 280,
                main_chars: meta.main_chars ?? null,
                reply_chars: Array.isArray(meta.reply_chars) ? meta.reply_chars : []
              }
            };
            const b64 = Buffer.from(JSON.stringify(payload), 'utf8').toString('base64');
            console.log('X_DRAFT_PAYLOAD_BASE64=' + b64);
          "

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notify-artifacts
          path: artifacts/
