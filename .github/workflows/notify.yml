name: Notify & Post to X

on:
  push:
    branches: [main]
    paths:
      - "data/items.json"
      - "scripts/**"
      - ".github/workflows/notify.yml"
  pull_request:
    paths:
      - "data/items.json"
      - "scripts/**"
      - ".github/workflows/notify.yml"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "SNS ì‹¤ì œ ê²Œì‹œ ëŒ€ì‹  ë“œë¼ì´ëŸ° ìˆ˜í–‰"
        required: true
        default: true
        type: boolean

permissions:
  contents: read
  actions: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      added_count: ${{ steps.delta.outputs.added_count }}
      has_new: ${{ steps.delta.outputs.has_new }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build delta baseline
        run: |
          mkdir -p artifacts
          if git cat-file -e HEAD~1:data/items.json 2>/dev/null; then
            git show HEAD~1:data/items.json > artifacts/items.before.json
          else
            echo '{"items":[]}' > artifacts/items.before.json
          fi

      - name: Extract new items
        run: node scripts/extract-new-items.mjs --before artifacts/items.before.json --after data/items.json --output artifacts/new-items.json

      - name: Set delta outputs
        id: delta
        run: |
          COUNT=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('artifacts/new-items.json','utf8'));process.stdout.write(String(d.added_count||0));")
          echo "added_count=${COUNT}" >> "$GITHUB_OUTPUT"
          if [ "$COUNT" -gt 0 ]; then
            echo "has_new=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build digest
        if: steps.delta.outputs.has_new == 'true'
        run: node scripts/build-digest.mjs --input artifacts/new-items.json --out-dir artifacts --site-base-url "https://chanmuzi.github.io/NLP-Paper-News/"

      - name: Job summary
        if: always()
        run: |
          echo "## Notify pipeline summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- added_count: ${{ steps.delta.outputs.added_count }}" >> "$GITHUB_STEP_SUMMARY"
          if [ -f artifacts/social-draft.md ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Social draft preview" >> "$GITHUB_STEP_SUMMARY"
            head -n 40 artifacts/social-draft.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notify-artifacts
          path: artifacts/

  post_x:
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.has_new == 'true' && vars.ENABLE_X_POST == 'true' && github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/download-artifact@v4
        with:
          name: notify-artifacts
          path: artifacts
      - name: Post to X
        id: post
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          X_API_BASE: ${{ vars.X_API_BASE }}
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          node scripts/post-x.mjs --digest artifacts/digest.json --result artifacts/post-result.json $DRY_RUN_FLAG
      - name: Post to X summary
        if: always()
        run: |
          echo "## X Post Result" >> "$GITHUB_STEP_SUMMARY"
          if [ -f artifacts/post-result.json ]; then
            node -e "
              const r = JSON.parse(require('fs').readFileSync('artifacts/post-result.json','utf8'));
              const lines = [];
              if (r.success) {
                lines.push('âœ… **Thread posted successfully**');
                lines.push('');
                lines.push('| # | Type | Tweet ID |');
                lines.push('|---|------|----------|');
                r.posted.forEach((t,i) => lines.push('| ' + (i+1) + ' | ' + t.type + ' | [' + t.id + '](https://x.com/i/status/' + t.id + ') |'));
              } else {
                lines.push('âŒ **Thread posting failed** (reply ' + r.failedAt + '/' + r.totalReplies + ')');
                lines.push('');
                lines.push('**Error:** \`' + r.error + '\`');
                lines.push('');
                if (r.rolledBack > 0) {
                  lines.push('ðŸ”„ Rolled back ' + r.rolledBack + '/' + r.posted.length + ' tweet(s)');
                }
                lines.push('');
                lines.push('Re-trigger this workflow to retry.');
              }
              process.stdout.write(lines.join('\n'));
            " >> "$GITHUB_STEP_SUMMARY"
          elif [ "${{ steps.post.outcome }}" = "success" ]; then
            echo "âœ… Thread posted successfully" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ **Thread posting failed**" >> "$GITHUB_STEP_SUMMARY"
            echo "Re-trigger this workflow to retry." >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Trigger deploy on success
        if: steps.post.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh workflow run deploy.yml --ref main
