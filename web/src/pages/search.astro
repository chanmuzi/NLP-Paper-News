---
import Layout from '../layouts/Layout.astro';
import itemsData from '../../../data/items.json';

// Get all unique organizations sorted by frequency
const orgCounts: Record<string, number> = {};
itemsData.items.forEach(i => { orgCounts[i.org] = (orgCounts[i.org] || 0) + 1; });
const orgs = Object.entries(orgCounts).sort((a, b) => b[1] - a[1]).map(e => e[0]);

// Get unique years
const years = [...new Set(itemsData.items.map(i => i.year))].sort().reverse();

// Stats
const stats = itemsData.stats || {};
---

<Layout title="ê²€ìƒ‰ - chanmuzi AI íë ˆì´ì…˜">
  <!-- Header -->
  <section class="mb-6">
    <div class="flex items-center gap-3 mb-4">
      <a href={`${import.meta.env.BASE_URL}`} class="text-gray-400 hover:text-claude-500 transition-colors text-sm">
        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        í™ˆ
      </a>
    </div>
    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">ê²€ìƒ‰</h1>
    <p class="text-sm text-gray-500 dark:text-gray-400">
      ì´ <span class="font-semibold text-claude-600 dark:text-claude-400">{itemsData.total_items.toLocaleString()}</span>ê°œ í•­ëª©
    </p>
  </section>

  <!-- Search & Filters -->
  <section class="bg-white dark:bg-anthro-darkSurface rounded-xl border border-gray-200 dark:border-gray-800 p-5 mb-6">
    <!-- Keyword -->
    <div class="relative mb-4">
      <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <input
        type="text"
        id="keyword-input"
        placeholder="í‚¤ì›Œë“œ, ë…¼ë¬¸ ì œëª©, ê¸°ê´€ ê²€ìƒ‰..."
        class="w-full pl-11 pr-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:border-claude-500 dark:focus:border-claude-500 outline-none transition-all text-sm"
      />
      <span id="result-count" class="absolute right-3.5 top-1/2 -translate-y-1/2 text-xs text-gray-400 dark:text-gray-500 font-mono hidden"></span>
    </div>

    <!-- Filter row -->
    <div class="flex flex-wrap gap-2">
      <select id="type-select" class="px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-gray-700 dark:text-gray-300 text-sm outline-none focus:border-claude-500 transition-all">
        <option value="">ì „ì²´ íƒ€ì…</option>
        <option value="paper">ğŸ“œ Paper ({stats.paper || 0})</option>
        <option value="dev">ğŸ§‘ğŸ»â€ğŸ’» Dev ({stats.dev || 0})</option>
        <option value="news">ğŸ—ï¸ News ({stats.news || 0})</option>
      </select>

      <select id="year-select" class="px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-gray-700 dark:text-gray-300 text-sm outline-none focus:border-claude-500 transition-all">
        <option value="">ì „ì²´ ì—°ë„</option>
        {years.map((year) => (
          <option value={year}>{year}ë…„</option>
        ))}
      </select>

      <select id="org-select" class="px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-gray-700 dark:text-gray-300 text-sm outline-none focus:border-claude-500 transition-all max-w-[200px]">
        <option value="">ì „ì²´ ê¸°ê´€</option>
        {orgs.slice(0, 200).map((org) => (
          <option value={org}>{org} ({orgCounts[org]})</option>
        ))}
      </select>

      <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-gray-700 dark:text-gray-300 text-sm cursor-pointer hover:border-claude-400 transition-all">
        <input type="checkbox" id="bookmark-filter" class="accent-claude-500 w-3.5 h-3.5" />
        ë¶ë§ˆí¬ë§Œ
      </label>

      <button id="reset-btn" class="px-3 py-2 text-sm text-gray-400 hover:text-claude-500 transition-colors">
        ì´ˆê¸°í™”
      </button>
    </div>
  </section>

  <!-- Results -->
  <section>
    <div id="results-grid" class="grid gap-3 md:grid-cols-2"></div>
    <div id="no-results" class="hidden text-center py-20">
      <div class="text-4xl mb-3 opacity-40">ğŸ”</div>
      <p class="text-gray-500 dark:text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
      <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
    </div>
    <div id="load-more-container" class="text-center mt-6 hidden">
      <button id="load-more-btn" class="px-6 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 text-sm font-medium text-gray-600 dark:text-gray-400 hover:border-claude-400 hover:text-claude-500 transition-all">
        ë” ë³´ê¸°
      </button>
    </div>
  </section>
</Layout>

<script define:vars={{ allItems: JSON.stringify(itemsData.items.sort((a: any, b: any) => {
  const parseDate = (d: string) => {
    const parts = d.split('-');
    return (parseInt(parts[0]) || 0) * 10000 + (parseInt(parts[1]) || 0) * 100 + (parseInt(parts[2]?.replace('W', '')) || 0);
  };
  return parseDate(b.date) - parseDate(a.date);
})) }}>

  const items = JSON.parse(allItems);
  const PER_PAGE = 40;
  let displayCount = PER_PAGE;

  const grid = document.getElementById('results-grid');
  const noResults = document.getElementById('no-results');
  const resultCount = document.getElementById('result-count');
  const loadMoreContainer = document.getElementById('load-more-container');
  const loadMoreBtn = document.getElementById('load-more-btn');
  const keywordInput = document.getElementById('keyword-input');
  const typeSelect = document.getElementById('type-select');
  const yearSelect = document.getElementById('year-select');
  const orgSelect = document.getElementById('org-select');
  const bookmarkFilter = document.getElementById('bookmark-filter');
  const hasToken = !!localStorage.getItem('github_token');

  function getBookmarks() {
    try { return JSON.parse(localStorage.getItem('bookmarks') || '[]'); }
    catch { return []; }
  }

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function highlightText(text, query) {
    if (!query) return escapeHtml(text);
    const escaped = escapeHtml(text);
    const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escapedQuery})`, 'gi');
    return escaped.replace(regex, '<mark class="search-highlight">$1</mark>');
  }

  function getFilteredItems() {
    const keyword = keywordInput.value.toLowerCase().trim();
    const type = typeSelect.value;
    const year = yearSelect.value;
    const org = orgSelect.value;
    const bookmarksOnly = bookmarkFilter.checked;
    const bookmarks = getBookmarks();

    return items.filter(item => {
      if (type && item.type !== type) return false;
      if (year && item.year !== year) return false;
      if (org && item.org !== org) return false;
      if (bookmarksOnly && !bookmarks.includes(item.id)) return false;
      if (keyword) {
        const searchText = `${item.title} ${item.org} ${item.bullets.map(b => b.text).join(' ')}`.toLowerCase();
        if (!searchText.includes(keyword)) return false;
      }
      return true;
    });
  }

  function renderCard(item, query) {
    const typeInfo = {
      paper: { icon: 'ğŸ“œ', label: 'Paper', color: 'text-blue-800 dark:text-blue-300', bgLight: 'bg-white border-blue-200/60 shadow-card', bgDark: 'dark:bg-anthro-darkSurface dark:border-blue-800/40 dark:shadow-card-dark', accent: 'bg-blue-500' },
      dev: { icon: 'ğŸ§‘ğŸ»â€ğŸ’»', label: 'Dev', color: 'text-emerald-800 dark:text-emerald-300', bgLight: 'bg-white border-emerald-200/60 shadow-card', bgDark: 'dark:bg-anthro-darkSurface dark:border-emerald-800/40 dark:shadow-card-dark', accent: 'bg-emerald-500' },
      news: { icon: 'ğŸ—ï¸', label: 'News', color: 'text-violet-800 dark:text-violet-300', bgLight: 'bg-white border-violet-200/60 shadow-card', bgDark: 'dark:bg-anthro-darkSurface dark:border-violet-800/40 dark:shadow-card-dark', accent: 'bg-violet-500' },
    };
    const info = typeInfo[item.type] || typeInfo.paper;
    const dateStr = item.year && item.month ? `${item.year}.${String(item.month).padStart(2, '0')} ${item.week ? item.week + 'ì£¼ì°¨' : ''}` : '';
    const bookmarks = getBookmarks();
    const isBookmarked = bookmarks.includes(item.id);

    const bulletsHtml = item.bullets.slice(0, 3).map(b => {
      const cls = b.level > 1 ? 'ml-4 text-gray-500 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300';
      const dotCls = b.level > 1 ? 'bg-gray-400 dark:bg-gray-600' : info.accent;
      return `<li class="flex items-start gap-2 ${cls}"><span class="mt-[7px] w-1 h-1 rounded-full flex-shrink-0 ${dotCls}"></span><span>${highlightText(b.text, query)}</span></li>`;
    }).join('');

    const extraBullets = item.bullets.slice(3);
    const extraHtml = extraBullets.length > 0 ? `
      <div class="bullets-extra hidden">
        <ul class="space-y-1 text-[13px] leading-relaxed mt-1">
          ${extraBullets.map(b => {
            const cls = b.level > 1 ? 'ml-4 text-gray-500 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300';
            const dotCls = b.level > 1 ? 'bg-gray-400 dark:bg-gray-600' : info.accent;
            return `<li class="flex items-start gap-2 ${cls}"><span class="mt-[7px] w-1 h-1 rounded-full flex-shrink-0 ${dotCls}"></span><span>${highlightText(b.text, query)}</span></li>`;
          }).join('')}
        </ul>
      </div>` : '';

    const expandBtn = extraBullets.length > 0 ? `<button class="expand-btn text-xs font-medium text-claude-600 hover:text-claude-700 dark:text-claude-400 dark:hover:text-claude-300 transition-colors">+${extraBullets.length}ê°œ ë” ë³´ê¸°</button>` : '';

    return `
    <article class="item-card group relative rounded-xl border transition-all duration-200 hover:shadow-card-hover dark:hover:shadow-card-dark-hover ${info.bgLight} ${info.bgDark} animate-fade-in-up" data-id="${item.id}">
      <div class="absolute top-0 left-0 w-1 h-full rounded-l-xl ${info.accent}"></div>
      <div class="pl-4 pr-4 py-4">
        <div class="flex items-center justify-between gap-2 mb-2.5">
          <div class="flex items-center gap-2 min-w-0">
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-xs font-semibold ${info.color} bg-white/60 dark:bg-white/5">${info.icon} ${info.label}</span>
            <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-md truncate">${highlightText(item.org, query)}</span>
          </div>
          <span class="text-xs text-gray-400 dark:text-gray-500 font-mono flex-shrink-0">${dateStr}</span>
        </div>
        ${item.url
          ? `<a href="${item.url}" target="_blank" rel="noopener noreferrer" class="block text-[15px] font-bold text-gray-900 dark:text-gray-100 hover:text-claude-600 dark:hover:text-claude-400 transition-colors mb-2 leading-snug">${highlightText(item.title, query)}<svg class="inline-block w-3.5 h-3.5 ml-1 opacity-0 group-hover:opacity-50 transition-opacity -translate-y-px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>`
          : `<h3 class="text-[15px] font-bold text-gray-900 dark:text-gray-100 mb-2 leading-snug">${highlightText(item.title, query)}</h3>`
        }
        ${item.bullets.length > 0 ? `<div class="bullets-container"><ul class="space-y-1 text-[13px] leading-relaxed">${bulletsHtml}</ul>${extraHtml}</div>` : ''}
        <div class="flex items-center justify-between mt-3 pt-2.5 border-t border-gray-200/50 dark:border-gray-800/30">
          <div>${expandBtn}</div>
          <div class="flex items-center gap-0.5">
            <button class="bookmark-btn p-1.5 rounded-md ${isBookmarked ? 'text-claude-500 dark:text-claude-400' : 'text-gray-300 dark:text-gray-600'} hover:text-claude-500 dark:hover:text-claude-400 transition-colors" data-id="${item.id}" title="ë¶ë§ˆí¬">
              <svg class="w-4 h-4 bookmark-icon-empty ${isBookmarked ? 'hidden' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
              <svg class="w-4 h-4 bookmark-icon-filled ${isBookmarked ? '' : 'hidden'}" fill="currentColor" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
            </button>
            <button class="share-btn p-1.5 rounded-md text-gray-300 hover:text-claude-500 dark:text-gray-600 dark:hover:text-claude-400 transition-colors" data-title="${escapeHtml(item.title)}" data-url="${item.url}" data-org="${escapeHtml(item.org)}" title="ê³µìœ ">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
            </button>
            ${hasToken ? `<button class="delete-btn p-1.5 rounded-md text-gray-300 hover:text-red-500 dark:text-gray-600 dark:hover:text-red-400 transition-colors" data-id="${item.id}" data-title="${escapeHtml(item.title)}" title="ì‚­ì œ">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>` : ''}
          </div>
        </div>
      </div>
    </article>`;
  }

  function render() {
    const keyword = keywordInput.value.toLowerCase().trim();
    const filtered = getFilteredItems();

    resultCount.textContent = `${filtered.length}ê±´`;
    resultCount.classList.toggle('hidden', false);

    if (filtered.length === 0) {
      grid.innerHTML = '';
      grid.classList.add('hidden');
      noResults.classList.remove('hidden');
      loadMoreContainer.classList.add('hidden');
      return;
    }

    grid.classList.remove('hidden');
    noResults.classList.add('hidden');

    const toShow = filtered.slice(0, displayCount);
    grid.innerHTML = toShow.map(item => renderCard(item, keyword)).join('');

    // Load more
    const remaining = filtered.length - displayCount;
    if (remaining > 0) {
      loadMoreContainer.classList.remove('hidden');
      loadMoreBtn.textContent = `ë” ë³´ê¸° (${remaining}ê±´ ë‚¨ìŒ)`;
    } else {
      loadMoreContainer.classList.add('hidden');
    }

    // Attach dynamic event listeners
    attachCardListeners();
  }

  function attachCardListeners() {
    // Expand buttons
    grid.querySelectorAll('.expand-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const card = btn.closest('.item-card');
        const extra = card?.querySelector('.bullets-extra');
        if (!extra) return;
        const isHidden = extra.classList.contains('hidden');
        extra.classList.toggle('hidden');
        btn.textContent = isHidden ? 'ì ‘ê¸°' : `+${extra.querySelectorAll('li').length}ê°œ ë” ë³´ê¸°`;
      });
    });

    // Bookmark buttons
    grid.querySelectorAll('.bookmark-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        let bk = getBookmarks();
        const idx = bk.indexOf(id);
        const empty = btn.querySelector('.bookmark-icon-empty');
        const filled = btn.querySelector('.bookmark-icon-filled');

        if (idx >= 0) {
          bk.splice(idx, 1);
          empty?.classList.remove('hidden');
          filled?.classList.add('hidden');
          btn.classList.remove('text-claude-500', 'dark:text-claude-400');
          btn.classList.add('text-gray-300', 'dark:text-gray-600');
          showToast('ë¶ë§ˆí¬ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
          bk.push(id);
          empty?.classList.add('hidden');
          filled?.classList.remove('hidden');
          btn.classList.add('text-claude-500', 'dark:text-claude-400');
          btn.classList.remove('text-gray-300', 'dark:text-gray-600');
          showToast('ë¶ë§ˆí¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        localStorage.setItem('bookmarks', JSON.stringify(bk));
      });
    });

    // Share buttons
    grid.querySelectorAll('.share-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const title = btn.dataset.title;
        const url = btn.dataset.url;
        const org = btn.dataset.org;
        const text = `${title} (${org})`;
        if (navigator.share) {
          navigator.share({ title: text, url }).catch(() => {});
        } else {
          navigator.clipboard.writeText(`${text}\n${url}`).then(() => showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤'));
        }
      });
    });

    // Delete buttons
    grid.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const title = btn.dataset.title;
        if (confirm(`"${title}" í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          deleteFromGitHub(id, title);
        }
      });
    });
  }

  async function deleteFromGitHub(itemId, itemTitle) {
    const token = localStorage.getItem('github_token');
    const repo = localStorage.getItem('github_repo') || 'chanmuzi/NLP-Paper-News';
    if (!token) { showToast('GitHub í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'); return; }

    showToast('ì‚­ì œ ì²˜ë¦¬ ì¤‘...');

    try {
      const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' };
      const postHeaders = { ...headers, 'Content-Type': 'application/json' };

      // Fetch current items.json
      const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/data/items.json`, { headers });
      if (!getRes.ok) throw new Error(`GitHub API ì˜¤ë¥˜ (${getRes.status})`);
      const fileData = await getRes.json();

      // Decode content (handle large files via Blob API)
      let base64Content;
      if (fileData.content) {
        base64Content = fileData.content.replace(/\n/g, '');
      } else {
        const blobRes = await fetch(`https://api.github.com/repos/${repo}/git/blobs/${fileData.sha}`, { headers });
        if (!blobRes.ok) throw new Error('Blob API ì˜¤ë¥˜');
        base64Content = (await blobRes.json()).content.replace(/\n/g, '');
      }
      const bin = atob(base64Content);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      const currentContent = JSON.parse(new TextDecoder('utf-8').decode(bytes));

      // Remove item
      const beforeCount = currentContent.items.length;
      currentContent.items = currentContent.items.filter(i => i.id !== itemId);
      if (currentContent.items.length === beforeCount) { showToast('í•´ë‹¹ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

      currentContent.total_items = currentContent.items.length;
      currentContent.last_updated = new Date().toISOString();
      currentContent.stats = {
        total: currentContent.items.length,
        paper: currentContent.items.filter(i => i.type === 'paper').length,
        dev: currentContent.items.filter(i => i.type === 'dev').length,
        news: currentContent.items.filter(i => i.type === 'news').length,
      };

      // Encode
      const uint8 = new TextEncoder().encode(JSON.stringify(currentContent, null, 2));
      let binary = '';
      for (let i = 0; i < uint8.length; i++) binary += String.fromCharCode(uint8[i]);
      const newBase64 = btoa(binary);

      // Git Data API: blob â†’ ref â†’ commit â†’ tree â†’ new commit â†’ update ref
      const blobRes = await fetch(`https://api.github.com/repos/${repo}/git/blobs`, {
        method: 'POST', headers: postHeaders,
        body: JSON.stringify({ content: newBase64, encoding: 'base64' }),
      });
      if (!blobRes.ok) throw new Error('Blob ìƒì„± ì‹¤íŒ¨');
      const newBlob = await blobRes.json();

      const refRes = await fetch(`https://api.github.com/repos/${repo}/git/ref/heads/main`, { headers });
      if (!refRes.ok) throw new Error('ë¸Œëœì¹˜ ì°¸ì¡° ì‹¤íŒ¨');
      const latestSha = (await refRes.json()).object.sha;

      const commitRes = await fetch(`https://api.github.com/repos/${repo}/git/commits/${latestSha}`, { headers });
      if (!commitRes.ok) throw new Error('ì»¤ë°‹ ì •ë³´ ì‹¤íŒ¨');
      const treeSha = (await commitRes.json()).tree.sha;

      const treeRes = await fetch(`https://api.github.com/repos/${repo}/git/trees`, {
        method: 'POST', headers: postHeaders,
        body: JSON.stringify({ base_tree: treeSha, tree: [{ path: 'data/items.json', mode: '100644', type: 'blob', sha: newBlob.sha }] }),
      });
      if (!treeRes.ok) throw new Error('íŠ¸ë¦¬ ìƒì„± ì‹¤íŒ¨');

      const newCommitRes = await fetch(`https://api.github.com/repos/${repo}/git/commits`, {
        method: 'POST', headers: postHeaders,
        body: JSON.stringify({ message: `Delete item: ${itemTitle}`, tree: (await treeRes.json()).sha, parents: [latestSha] }),
      });
      if (!newCommitRes.ok) throw new Error('ì»¤ë°‹ ìƒì„± ì‹¤íŒ¨');

      const updateRes = await fetch(`https://api.github.com/repos/${repo}/git/refs/heads/main`, {
        method: 'PATCH', headers: postHeaders,
        body: JSON.stringify({ sha: (await newCommitRes.json()).sha }),
      });
      if (!updateRes.ok) throw new Error('ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');

      // Remove from local array and re-render
      const idx = items.findIndex(i => i.id === itemId);
      if (idx >= 0) items.splice(idx, 1);
      render();
      showToast(`"${itemTitle}" í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
    } catch (err) {
      showToast(`ì‚­ì œ ì‹¤íŒ¨: ${err.message}`);
    }
  }

  function showToast(msg) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }

  // Event listeners
  let debounceTimer;
  keywordInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => { displayCount = PER_PAGE; render(); }, 200);
  });

  [typeSelect, yearSelect, orgSelect].forEach(el => {
    el.addEventListener('change', () => { displayCount = PER_PAGE; render(); });
  });

  bookmarkFilter.addEventListener('change', () => { displayCount = PER_PAGE; render(); });

  loadMoreBtn.addEventListener('click', () => {
    displayCount += PER_PAGE;
    render();
  });

  document.getElementById('reset-btn').addEventListener('click', () => {
    keywordInput.value = '';
    typeSelect.value = '';
    yearSelect.value = '';
    orgSelect.value = '';
    bookmarkFilter.checked = false;
    displayCount = PER_PAGE;
    render();
  });

  // Read URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const urlOrg = urlParams.get('org');
  const urlKeyword = urlParams.get('q');
  const urlType = urlParams.get('type');

  if (urlOrg) {
    orgSelect.value = urlOrg;
  }
  if (urlKeyword) {
    keywordInput.value = urlKeyword;
  }
  if (urlType) {
    typeSelect.value = urlType;
  }

  // Initial render
  render();
</script>
