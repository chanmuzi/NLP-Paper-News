---
import Layout from '../layouts/Layout.astro';

// Get current date info for defaults
const now = new Date();
const currentYear = now.getFullYear().toString();
const currentMonth = (now.getMonth() + 1).toString();
// ISO week: calculate week of month
const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
const currentWeek = Math.ceil((now.getDate() + firstDay) / 7).toString();
---

<Layout title="í•­ëª© ì¶”ê°€ - chanmuzi AI íë ˆì´ì…˜">
  <section class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-4">
      <a href={`${import.meta.env.BASE_URL}`} class="text-gray-400 hover:text-claude-500 transition-colors text-sm">
        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        í™ˆ
      </a>
    </div>

    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">ìƒˆ í•­ëª© ì¶”ê°€</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">ê°„í¸í•˜ê²Œ ë˜ëŠ” ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”</p>
      </div>
      <!-- GitHub Token -->
      <button id="toggle-settings" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 text-xs text-gray-500 hover:border-claude-400 hover:text-claude-500 transition-all">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        GitHub
        <span id="token-status" class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-xs"></span>
      </button>
    </div>

    <!-- GitHub Settings Panel -->
    <div id="settings-panel" class="hidden mb-6 p-4 bg-white dark:bg-anthro-darkSurface rounded-xl border border-gray-200 dark:border-gray-800">
      <p class="text-xs text-gray-500 mb-3">
        GitHub Personal Access Tokenì„ ì…ë ¥í•˜ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í•­ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
        í† í°ì€ ë¸Œë¼ìš°ì € localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
      </p>
      <div class="flex gap-2">
        <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
          class="flex-1 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 outline-none focus:border-claude-500 transition-all font-mono" />
        <button id="save-token" class="px-4 py-2 rounded-lg bg-claude-500 text-white text-sm font-medium hover:bg-claude-600 transition-all">ì €ì¥</button>
        <button id="clear-token" class="px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 text-sm text-gray-500 hover:text-red-500 hover:border-red-300 transition-all">ì‚­ì œ</button>
      </div>
      <div class="mt-3">
        <label class="block text-xs text-gray-500 mb-1">Repository (owner/repo)</label>
        <input type="text" id="github-repo" value="chanmuzi/NLP-Paper-News"
          class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 outline-none focus:border-claude-500 transition-all font-mono" />
      </div>
    </div>

    <!-- Date (shared) -->
    <div class="flex items-center gap-3 mb-5 bg-white dark:bg-anthro-darkSurface rounded-xl border border-gray-200 dark:border-gray-800 px-4 py-3">
      <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">ë‚ ì§œ</span>
      <div class="flex items-center gap-2">
        <input type="number" id="input-year" value={currentYear} min="2020" max="2030"
          class="w-[4.5rem] px-2 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 outline-none focus:border-claude-500 transition-all font-mono text-center" />
        <span class="text-gray-400 text-xs">ë…„</span>
        <input type="number" id="input-month" value={currentMonth} min="1" max="12"
          class="w-14 px-2 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 outline-none focus:border-claude-500 transition-all font-mono text-center" />
        <span class="text-gray-400 text-xs">ì›”</span>
        <input type="number" id="input-week" value={currentWeek} min="1" max="5"
          class="w-14 px-2 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 outline-none focus:border-claude-500 transition-all font-mono text-center" />
        <span class="text-gray-400 text-xs">ì£¼ì°¨</span>
      </div>
      <span class="ml-auto text-xs text-gray-400">ìë™ ì„¤ì •ë¨</span>
    </div>

    <!-- Mode Tabs -->
    <div class="flex mb-5 bg-gray-100 dark:bg-anthro-darkMid rounded-lg p-0.5">
      <button id="tab-markdown" class="tab-btn flex-1 py-2 rounded-md text-sm font-semibold transition-all bg-white dark:bg-anthro-darkSurface text-gray-900 dark:text-gray-100 shadow-sm">
        ë§ˆí¬ë‹¤ìš´ ë¶™ì—¬ë„£ê¸°
      </button>
      <button id="tab-simple" class="tab-btn flex-1 py-2 rounded-md text-sm font-semibold transition-all text-gray-500 dark:text-gray-400">
        ê°„í¸ ì¶”ê°€
      </button>
    </div>

    <!-- Simple Mode -->
    <div id="panel-simple" class="hidden bg-white dark:bg-anthro-darkSurface rounded-xl border border-gray-200 dark:border-gray-800 p-5 mb-5">
      <!-- Type Selector -->
      <div class="mb-4">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">ìœ í˜•</label>
        <div class="flex gap-2" id="type-selector">
          <button data-type="paper" class="type-btn active flex-1 py-2.5 rounded-lg border-2 border-claude-400 bg-claude-50 dark:bg-claude-950/20 text-sm font-semibold text-claude-700 dark:text-claude-300 transition-all">
            ğŸ“œ Paper
          </button>
          <button data-type="dev" class="type-btn flex-1 py-2.5 rounded-lg border-2 border-gray-200 dark:border-gray-700 text-sm font-semibold text-gray-500 dark:text-gray-400 transition-all hover:border-anthro-green-500">
            ğŸ§‘ğŸ»â€ğŸ’» Dev
          </button>
          <button data-type="news" class="type-btn flex-1 py-2.5 rounded-lg border-2 border-gray-200 dark:border-gray-700 text-sm font-semibold text-gray-500 dark:text-gray-400 transition-all hover:border-anthro-blue-500">
            ğŸ—ï¸ News
          </button>
        </div>
      </div>

      <!-- Org -->
      <div class="mb-3">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">ê¸°ê´€ëª…</label>
        <input type="text" id="simple-org" placeholder="ì˜ˆ: Anthropic, Google DeepMind"
          class="w-full px-3 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 outline-none focus:border-claude-500 transition-all" />
      </div>

      <!-- Title -->
      <div class="mb-3">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">ì œëª©</label>
        <input type="text" id="simple-title" placeholder="ì˜ˆ: Constitutional AI: Harmlessness from AI Feedback"
          class="w-full px-3 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 outline-none focus:border-claude-500 transition-all" />
      </div>

      <!-- URL -->
      <div class="mb-3">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">URL</label>
        <input type="url" id="simple-url" placeholder="https://arxiv.org/abs/..."
          class="w-full px-3 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 outline-none focus:border-claude-500 transition-all font-mono" />
      </div>

      <!-- Bullets -->
      <div class="mb-4">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">
          ì„¤ëª… <span class="font-normal normal-case tracking-normal text-gray-400">(ì¤„ë§ˆë‹¤ í•˜ë‚˜ì”©, íƒ­ ë˜ëŠ” 4ì¹¸ìœ¼ë¡œ í•˜ìœ„ ì„¤ëª…)</span>
        </label>
        <textarea id="simple-bullets" rows="5"
          placeholder="ì£¼ìš” ë‚´ìš© ì²« ë²ˆì§¸ ì¤„
í•˜ìœ„ ì„¤ëª…ì€ íƒ­ ë˜ëŠ” 4ì¹¸ ë“¤ì—¬ì“°ê¸°
    ì´ëŸ° ì‹ìœ¼ë¡œ í•˜ìœ„ ì„¤ëª… ì¶”ê°€"
          class="w-full px-3 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 outline-none focus:border-claude-500 transition-all font-mono leading-relaxed"></textarea>
      </div>

      <button id="simple-add-btn" class="w-full px-5 py-2.5 bg-claude-500 text-white rounded-lg text-sm font-semibold hover:bg-claude-600 transition-all shadow-sm">
        ë¯¸ë¦¬ë³´ê¸°ì— ì¶”ê°€
      </button>
    </div>

    <!-- Markdown Mode -->
    <div id="panel-markdown" class="bg-white dark:bg-anthro-darkSurface rounded-xl border border-gray-200 dark:border-gray-800 p-5 mb-5">
      <div class="mb-3">
        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">ë§ˆí¬ë‹¤ìš´ ì…ë ¥</label>
      </div>

      <!-- Fallback type for markdown without emoji -->
      <div class="flex items-center gap-2 mb-3">
        <span class="text-xs text-gray-500">ì´ëª¨ì§€ ì—†ëŠ” í•­ëª©ì˜ ê¸°ë³¸ ìœ í˜•:</span>
        <select id="md-fallback-type" class="px-2 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-xs text-gray-700 dark:text-gray-300 outline-none focus:border-claude-500">
          <option value="paper">ğŸ“œ Paper</option>
          <option value="dev">ğŸ§‘ğŸ»â€ğŸ’» Dev</option>
          <option value="news">ğŸ—ï¸ News</option>
        </select>
      </div>

      <textarea
        id="markdown-input"
        rows="12"
        placeholder="- ğŸ“œ [Anthropic] [Constitutional AI: Harmlessness from AI Feedback](https://arxiv.org/abs/2212.08073)
    - RLHF ëŒ€ì‹  AI í”¼ë“œë°±ìœ¼ë¡œ í—Œë²• ì›ì¹™ì„ í•™ìŠµí•˜ëŠ” ë°©ë²• ì œì•ˆ
        - ê¸°ì¡´ RLHFì˜ ì¸ê°„ í”¼ë“œë°± ì˜ì¡´ë„ë¥¼ ì¤„ì´ë©´ì„œ ì•ˆì „ì„± í–¥ìƒ
- ğŸ§‘ğŸ»â€ğŸ’» [Google DeepMind] [Gemma 3 Released](https://blog.google/gemma-3)
    - ì˜¤í”ˆ ì›¨ì´íŠ¸ ëª¨ë¸ Gemma 3 ê³µê°œ, ë‹¤êµ­ì–´ ì§€ì› ê°•í™”
- ğŸ—ï¸ [OpenAI] [GPT-5 ë°œí‘œ](https://openai.com/gpt-5)
    - ì°¨ì„¸ëŒ€ ëª¨ë¸ GPT-5 ê³µì‹ ë°œí‘œ"
        class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-anthro-darkMid text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 outline-none focus:border-claude-500 transition-all font-mono leading-relaxed"
      ></textarea>

      <div class="mt-3 flex gap-2">
        <button id="parse-btn" class="flex-1 px-5 py-2.5 bg-claude-500 text-white rounded-lg text-sm font-semibold hover:bg-claude-600 transition-all shadow-sm">
          íŒŒì‹± ë¯¸ë¦¬ë³´ê¸°
        </button>
        <button id="clear-md-btn" class="px-4 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-all">
          ì§€ìš°ê¸°
        </button>
      </div>

      <!-- Parse errors -->
      <div id="parse-errors" class="hidden mt-3 p-3 rounded-lg bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 text-xs text-amber-700 dark:text-amber-300"></div>
      <div id="parse-summary" class="hidden mt-3 p-3 rounded-lg bg-gray-50 dark:bg-anthro-darkMid border border-gray-200 dark:border-gray-700 text-xs text-gray-600 dark:text-gray-300"></div>
    </div>

    <!-- Preview -->
    <div id="preview-section" class="hidden mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">
          ë¯¸ë¦¬ë³´ê¸° <span id="preview-count" class="text-claude-500 font-mono">0</span>ê±´
        </h2>
        <button id="clear-preview" class="text-xs text-gray-400 hover:text-red-500 transition-colors">ì „ì²´ ì‚­ì œ</button>
      </div>
      <div id="preview-container" class="space-y-3"></div>

      <!-- Actions -->
      <div class="mt-5 flex gap-2">
        <button id="submit-btn" class="flex-1 px-5 py-2.5 bg-claude-500 text-white rounded-lg text-sm font-semibold hover:bg-claude-600 transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
          <svg class="submit-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          <svg class="submit-spinner hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span id="submit-btn-label">í™•ì¸í•˜ê³  ì¶”ê°€</span>
        </button>
        <button id="copy-json" class="px-4 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-all">
          JSON ë³µì‚¬
        </button>
      </div>

      <details class="mt-4">
        <summary class="text-xs text-gray-400 cursor-pointer hover:text-gray-600 transition-colors">JSON ì¶œë ¥ ë³´ê¸°</summary>
        <pre id="json-output" class="mt-2 bg-gray-950 text-claude-300 p-4 rounded-lg overflow-x-auto text-xs font-mono"></pre>
      </details>
    </div>

    <!-- Submit Status (outside preview-section so it stays visible after submit clears items) -->
    <div id="submit-status" class="hidden mt-3 p-4 rounded-xl text-sm"></div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50">
      <div id="confirm-backdrop" class="absolute inset-0 bg-black/40 animate-fade-in"></div>
      <div class="flex items-center justify-center min-h-full p-4">
        <div class="animate-fade-in-up relative max-w-md w-full bg-white dark:bg-anthro-darkSurface rounded-2xl border border-gray-200 dark:border-gray-800 shadow-xl p-6">
          <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-3">í•­ëª© ì¶”ê°€ í™•ì¸</h3>
          <p id="confirm-message" class="text-sm text-gray-600 dark:text-gray-300 mb-2"></p>
          <div id="confirm-item-list" class="mb-4 max-h-40 overflow-y-auto text-xs text-gray-500 dark:text-gray-400 space-y-1"></div>
          <div class="flex gap-2">
            <button id="confirm-cancel" class="flex-1 px-4 py-2.5 rounded-lg border border-gray-200 dark:border-gray-700 text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-all">ì·¨ì†Œ</button>
            <button id="confirm-submit" class="flex-1 px-4 py-2.5 rounded-lg bg-claude-500 text-white text-sm font-semibold hover:bg-claude-600 transition-all">ì¶”ê°€ ì‹¤í–‰</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let parsedItems: any[] = [];
  let selectedType = 'paper';
  let pendingSubmitItems: any[] = [];
  let submittedIds = new Set<string>();
  let existingIds = new Set<string>();  // IDs already committed to items.json
  let hasActiveWorkflowTracking = false;

  const WORKFLOW_TRACKING_KEY = 'nlp_paper_news_admin_workflow_tracking_v1';

  // â”€â”€â”€ Type colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const TYPE_COLORS: Record<string, { border: string; bg: string; text: string }> = {
    paper: { border: 'border-claude-400', bg: 'bg-claude-50 dark:bg-claude-950/20', text: 'text-claude-700 dark:text-claude-300' },
    dev: { border: 'border-anthro-green-500', bg: 'bg-anthro-green-200/30 dark:bg-anthro-green-800/20', text: 'text-anthro-green-700 dark:text-anthro-green-300' },
    news: { border: 'border-anthro-blue-500', bg: 'bg-anthro-blue-200/30 dark:bg-anthro-blue-800/20', text: 'text-anthro-blue-700 dark:text-anthro-blue-300' },
  };

  const TYPE_ICONS: Record<string, string> = { paper: 'ğŸ“œ', dev: 'ğŸ§‘ğŸ»â€ğŸ’»', news: 'ğŸ—ï¸' };

  const TYPE_MAP: Record<string, string> = {
    'ğŸ“œ': 'paper', 'ğŸ§‘ğŸ»â€ğŸ’»': 'dev', 'ğŸ§‘ğŸ»ğŸ’»': 'dev', 'ğŸ—ï¸': 'news', 'ğŸ—': 'news',
  };

  // â”€â”€â”€ Load existing IDs from GitHub â”€â”€â”€â”€â”€
  async function loadExistingIds() {
    const token = localStorage.getItem('github_token');
    if (!token) return;
    const repo = (document.getElementById('github-repo') as HTMLInputElement)?.value || 'chanmuzi/NLP-Paper-News';
    try {
      const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/data/items.json`, {
        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (!getRes.ok) return;
      const fileData = await getRes.json();

      let base64Content: string;
      if (fileData.content) {
        base64Content = fileData.content.replace(/\n/g, '');
      } else {
        const blobRes = await fetch(`https://api.github.com/repos/${repo}/git/blobs/${fileData.sha}`, {
          headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (!blobRes.ok) return;
        const blobData = await blobRes.json();
        base64Content = blobData.content.replace(/\n/g, '');
      }
      const binaryStr = atob(base64Content);
      const bytes = new Uint8Array(binaryStr.length);
      for (let i = 0; i < binaryStr.length; i++) {
        bytes[i] = binaryStr.charCodeAt(i);
      }
      const rawContent = new TextDecoder('utf-8').decode(bytes);
      const data = JSON.parse(rawContent);
      existingIds = new Set((data.items || []).map((i: any) => i.id));
    } catch { /* silently fail â€” graceful degradation */ }
  }

  // â”€â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const tabSimple = document.getElementById('tab-simple')!;
  const tabMarkdown = document.getElementById('tab-markdown')!;
  const panelSimple = document.getElementById('panel-simple')!;
  const panelMarkdown = document.getElementById('panel-markdown')!;

  function switchTab(tab: 'simple' | 'markdown') {
    if (tab === 'simple') {
      tabSimple.classList.add('bg-white', 'dark:bg-anthro-darkSurface', 'text-gray-900', 'dark:text-gray-100', 'shadow-sm');
      tabSimple.classList.remove('text-gray-500', 'dark:text-gray-400');
      tabMarkdown.classList.remove('bg-white', 'dark:bg-anthro-darkSurface', 'text-gray-900', 'dark:text-gray-100', 'shadow-sm');
      tabMarkdown.classList.add('text-gray-500', 'dark:text-gray-400');
      panelSimple.classList.remove('hidden');
      panelMarkdown.classList.add('hidden');
    } else {
      tabMarkdown.classList.add('bg-white', 'dark:bg-anthro-darkSurface', 'text-gray-900', 'dark:text-gray-100', 'shadow-sm');
      tabMarkdown.classList.remove('text-gray-500', 'dark:text-gray-400');
      tabSimple.classList.remove('bg-white', 'dark:bg-anthro-darkSurface', 'text-gray-900', 'dark:text-gray-100', 'shadow-sm');
      tabSimple.classList.add('text-gray-500', 'dark:text-gray-400');
      panelMarkdown.classList.remove('hidden');
      panelSimple.classList.add('hidden');
    }
  }

  tabSimple.addEventListener('click', () => switchTab('simple'));
  tabMarkdown.addEventListener('click', () => switchTab('markdown'));

  // â”€â”€â”€ Type selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = (btn as HTMLElement).dataset.type || 'paper';
      selectedType = type;
      const colors = TYPE_COLORS[type];

      document.querySelectorAll('.type-btn').forEach(b => {
        b.classList.remove('border-claude-400', 'bg-claude-50', 'dark:bg-claude-950/20', 'text-claude-700', 'dark:text-claude-300');
        b.classList.remove('border-anthro-green-500', 'bg-anthro-green-200/30', 'dark:bg-anthro-green-800/20', 'text-anthro-green-700', 'dark:text-anthro-green-300');
        b.classList.remove('border-anthro-blue-500', 'bg-anthro-blue-200/30', 'dark:bg-anthro-blue-800/20', 'text-anthro-blue-700', 'dark:text-anthro-blue-300');
        b.classList.add('border-gray-200', 'dark:border-gray-700', 'text-gray-500', 'dark:text-gray-400');
        b.classList.remove('active');
      });

      btn.classList.remove('border-gray-200', 'dark:border-gray-700', 'text-gray-500', 'dark:text-gray-400');
      btn.classList.add(...colors.border.split(' '), ...colors.bg.split(' '), ...colors.text.split(' '));
      btn.classList.add('active');
    });
  });

  // â”€â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getDateValues() {
    return {
      year: (document.getElementById('input-year') as HTMLInputElement).value,
      month: (document.getElementById('input-month') as HTMLInputElement).value,
      week: (document.getElementById('input-week') as HTMLInputElement).value,
    };
  }

  function makeId(org: string, title: string) {
    return `${org}-${title}`
      .toLowerCase()
      .replace(/[^a-z0-9ê°€-í£\s-]/g, '')
      .replace(/\s+/g, '-')
      .slice(0, 100);
  }

  function parseBulletsText(text: string): { text: string; level: number }[] {
    if (!text.trim()) return [];
    return text.split('\n').filter(l => l.trim()).map(line => {
      const leadingSpaces = line.match(/^(\s*)/)?.[1]?.length || 0;
      const hasTabs = line.match(/^\t/);
      const level = hasTabs ? 2 : (leadingSpaces >= 4 ? 2 : leadingSpaces >= 8 ? 3 : 1);
      return { text: line.trim(), level };
    });
  }

  function escapeHtml(s: string) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function getLocalDuplicateCount(items: any[]) {
    const ids = new Set<string>();
    let duplicateCount = 0;
    for (const item of items) {
      if (ids.has(item.id)) duplicateCount++;
      ids.add(item.id);
    }
    return duplicateCount;
  }

  function setSubmitLoading(isLoading: boolean) {
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;
    if (!submitBtn) return;
    const label = document.getElementById('submit-btn-label');
    const icon = submitBtn.querySelector('.submit-icon');
    const spinner = submitBtn.querySelector('.submit-spinner');
    submitBtn.disabled = isLoading;
    if (label) label.textContent = isLoading ? 'ì²˜ë¦¬ì¤‘...' : 'í™•ì¸í•˜ê³  ì¶”ê°€';
    if (icon) icon.classList.toggle('hidden', isLoading);
    if (spinner) spinner.classList.toggle('hidden', !isLoading);
  }

  function clearInputFields() {
    (document.getElementById('markdown-input') as HTMLTextAreaElement).value = '';
    (document.getElementById('simple-org') as HTMLInputElement).value = '';
    (document.getElementById('simple-title') as HTMLInputElement).value = '';
    (document.getElementById('simple-url') as HTMLInputElement).value = '';
    (document.getElementById('simple-bullets') as HTMLTextAreaElement).value = '';
    document.getElementById('parse-errors')?.classList.add('hidden');
    document.getElementById('parse-summary')?.classList.add('hidden');
  }

  // â”€â”€â”€ Simple Mode: Add â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('simple-add-btn')?.addEventListener('click', () => {
    const org = (document.getElementById('simple-org') as HTMLInputElement).value.trim();
    const title = (document.getElementById('simple-title') as HTMLInputElement).value.trim();
    const url = (document.getElementById('simple-url') as HTMLInputElement).value.trim();
    const bulletsText = (document.getElementById('simple-bullets') as HTMLTextAreaElement).value;

    if (!org || !title) {
      showToast('ê¸°ê´€ëª…ê³¼ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
      return;
    }

    const { year, month, week } = getDateValues();
    const item = {
      id: makeId(org, title),
      type: selectedType,
      org, title, url,
      date: `${year}-${month.padStart(2, '0')}-W${week.padStart(2, '0')}`,
      year, month, week,
      bullets: parseBulletsText(bulletsText),
      tags: [],
    };

    parsedItems.push(item);
    renderPreview();
    showToast('í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');

    // Clear simple fields (keep org and type)
    (document.getElementById('simple-title') as HTMLInputElement).value = '';
    (document.getElementById('simple-url') as HTMLInputElement).value = '';
    (document.getElementById('simple-bullets') as HTMLTextAreaElement).value = '';
  });

  // â”€â”€â”€ Markdown Parser (improved) â”€â”€â”€â”€â”€â”€â”€â”€
  function parseMarkdownItems(text: string, year: string, month: string, week: string, fallbackType: string): { items: any[]; errors: string[] } {
    const lines = text.split('\n');
    const items: any[] = [];
    const errors: string[] = [];
    let currentItem: any = null;
    let lineNum = 0;

    for (const line of lines) {
      lineNum++;
      if (!line.trim()) continue;

      // Match line starting with "- " (with optional emoji)
      const iconMatch = line.match(/^-\s*(ğŸ“œ|ğŸ§‘ğŸ»â€ğŸ’»|ğŸ§‘ğŸ»ğŸ’»|ğŸ—ï¸|ğŸ—)\s*/);
      const plainMatch = !iconMatch && line.match(/^-\s+\[/);

      if (iconMatch || plainMatch) {
        if (currentItem) items.push(currentItem);

        let type = fallbackType;
        let rest = '';

        if (iconMatch) {
          type = TYPE_MAP[iconMatch[1]] || fallbackType;
          rest = line.slice(iconMatch[0].length).trim();
        } else {
          // Plain format: - [Org] [Title](URL)
          rest = line.replace(/^-\s+/, '').trim();
        }

        // Parse first bracket [...]
        const firstBracket = rest.match(/^\[([^\]]+)\]/);
        if (!firstBracket) {
          errors.push(`${lineNum}í–‰: [ê¸°ê´€ëª…] ë˜ëŠ” [ì œëª©] í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
          currentItem = null;
          continue;
        }

        const firstContent = firstBracket[1];
        const afterFirst = rest.slice(firstBracket[0].length);

        let org = '';
        let title = '';
        let url = '';

        if (afterFirst.match(/^\s*\[/)) {
          // [Org] [Title](URL) or [Org] [Title]
          org = firstContent;
          const titlePart = afterFirst.trimStart();
          let bracketCount = 0;
          let titleEnd = -1;
          for (let i = 0; i < titlePart.length; i++) {
            if (titlePart[i] === '[') bracketCount++;
            else if (titlePart[i] === ']') {
              bracketCount--;
              if (bracketCount === 0) { titleEnd = i; break; }
            }
          }
          if (titleEnd > 0) {
            title = titlePart.slice(1, titleEnd).replace(/\*\*/g, '').trim();
            const afterTitle = titlePart.slice(titleEnd + 1).trim();
            const urlMatch = afterTitle.match(/^\(([^)]+)\)/);
            if (urlMatch) url = urlMatch[1];
          }
        } else if (afterFirst.match(/^\(/)) {
          // [Title](URL) â€” org ìƒëµ, ë§ˆí¬ë‹¤ìš´ ë§í¬
          title = firstContent.replace(/\*\*/g, '').trim();
          org = title;
          const urlMatch = afterFirst.match(/^\(([^)]+)\)/);
          if (urlMatch) url = urlMatch[1];
        } else if (afterFirst.trim()) {
          // [Org] plain text title
          org = firstContent;
          title = afterFirst.replace(/\*\*/g, '').trim();
        } else {
          // [Title] only
          title = firstContent.replace(/\*\*/g, '').trim();
          org = title;
        }

        if (!title) {
          errors.push(`${lineNum}í–‰: ì œëª©ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
          currentItem = null;
          continue;
        }

        currentItem = {
          id: makeId(org, title),
          type, org, title, url,
          date: `${year}-${month.padStart(2, '0')}-W${week.padStart(2, '0')}`,
          year, month, week,
          bullets: [], tags: [],
        };
        continue;
      }

      // Bullet lines: any indented line starting with -
      if (currentItem && line.match(/^[\s\t]+-/)) {
        const match = line.match(/^([\s\t]*)-\s+(.+)$/);
        if (match) {
          const rawIndent = match[1];
          const bulletText = match[2].trim();
          // Support both tabs and spaces
          const tabCount = (rawIndent.match(/\t/g) || []).length;
          const spaceCount = rawIndent.replace(/\t/g, '').length;
          const effectiveIndent = tabCount * 4 + spaceCount;
          const level = effectiveIndent < 6 ? 1 : effectiveIndent < 12 ? 2 : 3;
          currentItem.bullets.push({ text: bulletText, level });
        }
      } else if (currentItem && line.match(/^\s+[^-\s]/)) {
        // Continuation line (indented but no dash) - treat as bullet
        const text = line.trim();
        if (text) {
          const rawIndent = line.match(/^(\s*)/)?.[1] || '';
          const level = rawIndent.length >= 8 ? 2 : 1;
          currentItem.bullets.push({ text, level });
        }
      }
    }

    if (currentItem) items.push(currentItem);

    if (items.length === 0 && errors.length === 0) {
      errors.push('íŒŒì‹±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. "- [ê¸°ê´€ëª…] [ì œëª©](URL)" ë˜ëŠ” "- [ì œëª©](URL)" í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
    }

    return { items, errors };
  }

  // â”€â”€â”€ Parse button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('parse-btn')?.addEventListener('click', () => {
    const textarea = document.getElementById('markdown-input') as HTMLTextAreaElement;
    const fallbackType = (document.getElementById('md-fallback-type') as HTMLSelectElement).value;
    const { year, month, week } = getDateValues();
    const errorsEl = document.getElementById('parse-errors')!;
    const summaryEl = document.getElementById('parse-summary')!;

    const result = parseMarkdownItems(textarea.value, year, month, week, fallbackType);

    if (result.errors.length > 0) {
      errorsEl.innerHTML = result.errors.map(e => `<div>âš ï¸ ${escapeHtml(e)}</div>`).join('');
      errorsEl.classList.remove('hidden');
    } else {
      errorsEl.classList.add('hidden');
    }

    if (result.items.length > 0) {
      parsedItems = result.items;
      renderPreview();
      const localDuplicateCount = getLocalDuplicateCount(result.items);
      const alreadySubmitted = result.items.filter(i => submittedIds.has(i.id));
      const alreadyCommitted = result.items.filter(i => existingIds.has(i.id));
      const realNewCount = result.items.filter(i => !submittedIds.has(i.id) && !existingIds.has(i.id)).length;
      let summaryHtml = `
        <div class="font-semibold text-gray-700 dark:text-gray-200 mb-1">íŒŒì‹± í…ŒìŠ¤íŠ¸ ì™„ë£Œ</div>
        <div>ì¶”ê°€ í›„ë³´: <span class="font-mono font-semibold">${realNewCount}</span>ê±´${alreadyCommitted.length > 0 ? ` <span class="text-gray-400">(ì´ë¯¸ ì»¤ë°‹ë¨: ${alreadyCommitted.length}ê±´)</span>` : ''}</div>
        <div>í˜•ì‹ ì˜¤ë¥˜: <span class="font-mono font-semibold">${result.errors.length}</span>ê±´</div>
        <div>ì…ë ¥ ë‚´ë¶€ ì¤‘ë³µ(id): <span class="font-mono font-semibold">${localDuplicateCount}</span>ê±´</div>
      `;
      if (alreadyCommitted.length > 0) {
        summaryHtml += `<div class="mt-1 text-amber-600 dark:text-amber-400 font-semibold">ì´ë¯¸ ì»¤ë°‹ëœ í•­ëª© ${alreadyCommitted.length}ê±´ í¬í•¨ â€” ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì œê±°í•˜ê±°ë‚˜ ê·¸ëŒ€ë¡œ ë‘ë©´ ìë™ ê±´ë„ˆëœë‹ˆë‹¤</div>`;
      }
      if (alreadySubmitted.length > 0) {
        summaryHtml += `<div class="mt-1 text-red-600 dark:text-red-400 font-semibold">ì´ë¯¸ ì œì¶œëœ í•­ëª© ${alreadySubmitted.length}ê±´ í¬í•¨ â€” ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì¤‘ë³µ í•­ëª©ì„ ì œê±°í•´ì•¼ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>`;
      }
      summaryEl.innerHTML = summaryHtml;
      summaryEl.classList.remove('hidden');
      showToast(`${result.items.length}ê°œ í•­ëª©ì´ íŒŒì‹±ë˜ì—ˆìŠµë‹ˆë‹¤`);
    } else {
      summaryEl.classList.add('hidden');
    }
  });

  document.getElementById('clear-md-btn')?.addEventListener('click', () => {
    (document.getElementById('markdown-input') as HTMLTextAreaElement).value = '';
    document.getElementById('parse-errors')?.classList.add('hidden');
    document.getElementById('parse-summary')?.classList.add('hidden');
  });

  // â”€â”€â”€ Preview rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderPreview() {
    const container = document.getElementById('preview-container')!;
    const section = document.getElementById('preview-section')!;
    const countEl = document.getElementById('preview-count')!;
    const jsonOutput = document.getElementById('json-output');

    if (parsedItems.length === 0) {
      section.classList.add('hidden');
      return;
    }

    section.classList.remove('hidden');
    countEl.textContent = parsedItems.length.toString();

    container.innerHTML = parsedItems.map((item, idx) => {
      const icon = TYPE_ICONS[item.type] || 'ğŸ“œ';
      const colors = TYPE_COLORS[item.type] || TYPE_COLORS.paper;
      const dateDisplay = `${item.year}.${String(item.month).padStart(2, '0')} ${item.week}ì£¼ì°¨`;
      const urlDomain = item.url ? (() => { try { return new URL(item.url).hostname.replace('www.', ''); } catch { return ''; } })() : '';
      const isSessionDup = submittedIds.has(item.id);
      const isExistingDup = existingIds.has(item.id);
      const isDuplicate = isSessionDup || isExistingDup;
      const dupBorder = isDuplicate ? 'border-red-300 dark:border-red-800 opacity-60' : `${colors.border}/30`;
      const dupBadge = isExistingDup
        ? '<span class="text-xs font-semibold text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded-md">ì»¤ë°‹ ì™„ë£Œ</span>'
        : isSessionDup
        ? '<span class="text-xs font-semibold text-red-500 dark:text-red-400 bg-red-50 dark:bg-red-950/30 px-2 py-0.5 rounded-md">ì¤‘ë³µ</span>'
        : '';
      return `
        <div class="p-4 rounded-xl border ${colors.bg} ${dupBorder} relative group">
          <button class="remove-item absolute top-2 right-2 p-1 rounded-md text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all" data-idx="${idx}">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs font-bold ${colors.text}">${icon} ${item.type.toUpperCase()}</span>
            <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-md">${escapeHtml(item.org)}</span>
            ${dupBadge}
            <span class="text-xs text-gray-400 font-mono ml-auto">${dateDisplay}</span>
          </div>
          ${item.url
            ? `<a href="${item.url}" target="_blank" class="block text-[15px] font-bold text-gray-900 dark:text-gray-100 hover:text-claude-600 dark:hover:text-claude-400 transition-colors mb-1.5 leading-snug">${escapeHtml(item.title)} <svg class="inline w-3.5 h-3.5 ml-0.5 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>`
            : `<h3 class="text-[15px] font-bold text-gray-900 dark:text-gray-100 mb-1.5 leading-snug">${escapeHtml(item.title)}</h3>`
          }
          ${urlDomain ? `<span class="text-xs text-gray-400 mb-1 block">${urlDomain}</span>` : ''}
          ${item.bullets.length > 0 ? `
            <ul class="text-sm text-gray-700 dark:text-gray-300 space-y-1 mt-2">
              ${item.bullets.map((b: any) => `
                <li class="${b.level > 1 ? 'ml-4 text-xs text-gray-500' : ''} flex items-start gap-2">
                  <span class="mt-[7px] w-1 h-1 rounded-full bg-gray-400 flex-shrink-0"></span>
                  <span>${escapeHtml(b.text)}</span>
                </li>
              `).join('')}
            </ul>
          ` : ''}
        </div>
      `;
    }).join('');

    // Attach remove handlers
    container.querySelectorAll('.remove-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt((btn as HTMLElement).dataset.idx || '0');
        parsedItems.splice(idx, 1);
        renderPreview();
      });
    });

    if (jsonOutput) {
      jsonOutput.textContent = JSON.stringify(parsedItems, null, 2);
    }

    // Disable submit if all items are already submitted duplicates
    updateSubmitBtnState();
  }

  function updateSubmitBtnState() {
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;
    const label = document.getElementById('submit-btn-label');
    if (!submitBtn || !label) return;

    const newItems = parsedItems.filter(i => !submittedIds.has(i.id) && !existingIds.has(i.id));
    const duplicateCount = parsedItems.length - newItems.length;

    if (parsedItems.length > 0 && newItems.length === 0) {
      submitBtn.disabled = true;
      label.textContent = `ì œì¶œ ë¶ˆê°€ (${duplicateCount}ê±´ ì¤‘ë³µ)`;
    } else if (duplicateCount > 0) {
      submitBtn.disabled = true;
      label.textContent = `ì œì¶œ ë¶ˆê°€ (${duplicateCount}ê±´ ì¤‘ë³µ í¬í•¨)`;
    } else {
      submitBtn.disabled = false;
      label.textContent = 'í™•ì¸í•˜ê³  ì¶”ê°€';
    }
  }

  // Clear preview
  document.getElementById('clear-preview')?.addEventListener('click', () => {
    parsedItems = [];
    renderPreview();
    document.getElementById('preview-section')?.classList.add('hidden');
  });

  // â”€â”€â”€ GitHub API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function submitToGitHub(items: any[]) {
    const token = localStorage.getItem('github_token');
    const repo = (document.getElementById('github-repo') as HTMLInputElement)?.value || 'chanmuzi/NLP-Paper-News';

    if (!token) {
      showStatus('GitHub í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒë‹¨ GitHub ë²„íŠ¼ì—ì„œ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
      return;
    }

    setSubmitLoading(true);
    showStatus('1/4 ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ ì¤‘...', 'info');

    try {
      const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/data/items.json`, {
        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });

      if (!getRes.ok) {
        const errText = await getRes.text();
        throw new Error(`GitHub API ì˜¤ë¥˜ (${getRes.status}): ${getRes.statusText}. ${errText}`);
      }

      const fileData = await getRes.json();

      // Decode file content - use Blobs API for large files (>1MB)
      let rawContent: string;
      try {
        let base64Content: string;
        if (fileData.content) {
          // Small file: content available directly from Contents API
          base64Content = fileData.content.replace(/\n/g, '');
        } else {
          // Large file (>1MB): Contents API omits content, use Git Blobs API
          showStatus('1/4 ëŒ€ìš©ëŸ‰ íŒŒì¼ Blob APIë¡œ ì¡°íšŒ ì¤‘...', 'info');
          const blobRes = await fetch(`https://api.github.com/repos/${repo}/git/blobs/${fileData.sha}`, {
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
          });
          if (!blobRes.ok) {
            throw new Error(`Blob API ì˜¤ë¥˜ (${blobRes.status}): íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
          }
          const blobData = await blobRes.json();
          base64Content = blobData.content.replace(/\n/g, '');
        }
        const binaryStr = atob(base64Content);
        const bytes = new Uint8Array(binaryStr.length);
        for (let i = 0; i < binaryStr.length; i++) {
          bytes[i] = binaryStr.charCodeAt(i);
        }
        rawContent = new TextDecoder('utf-8').decode(bytes);
      } catch (e: any) {
        if (e.message.includes('Blob API')) throw e;
        throw new Error('items.json ë””ì½”ë”© ì‹¤íŒ¨. íŒŒì¼ì´ ë„ˆë¬´ í¬ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      }

      let currentContent: any;
      try {
        currentContent = JSON.parse(rawContent);
      } catch (e) {
        throw new Error('items.json JSON íŒŒì‹± ì‹¤íŒ¨. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.');
      }

      showStatus('2/4 ì¤‘ë³µ ê²€ì‚¬ ì¤‘...', 'info');
      const existingIds = new Set(currentContent.items.map((i: any) => i.id));
      const newItems = items.filter(i => !existingIds.has(i.id));
      const skippedCount = items.length - newItems.length;

      if (newItems.length === 0) {
        showStatus(`ì¶”ê°€í•  ìƒˆ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ${skippedCount}ê°œ í•­ëª©ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`, 'warn');
        return;
      }

      currentContent.items = [...newItems, ...currentContent.items];
      currentContent.total_items = currentContent.items.length;
      currentContent.last_updated = new Date().toISOString();
      currentContent.stats = {
        total: currentContent.items.length,
        paper: currentContent.items.filter((i: any) => i.type === 'paper').length,
        dev: currentContent.items.filter((i: any) => i.type === 'dev').length,
        news: currentContent.items.filter((i: any) => i.type === 'news').length,
      };

      showStatus('3/4 ì»¤ë°‹ ê°ì²´ ìƒì„± ì¤‘...', 'info');

      // Encode with proper UTF-8 handling
      const jsonStr = JSON.stringify(currentContent, null, 2);
      const encoder = new TextEncoder();
      const uint8 = encoder.encode(jsonStr);
      let binary = '';
      for (let i = 0; i < uint8.length; i++) {
        binary += String.fromCharCode(uint8[i]);
      }
      const newBase64 = btoa(binary);

      const titles = newItems.map((i: any) => i.title).slice(0, 3).join(', ');
      const commitMessage = `Add ${newItems.length} item(s): ${titles}`;

      // Use Git Data API for reliable large file commits
      // Step 1: Create a new blob with the updated content
      const blobRes = await fetch(`https://api.github.com/repos/${repo}/git/blobs`, {
        method: 'POST',
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: newBase64, encoding: 'base64' }),
      });
      if (!blobRes.ok) {
        const errData = await blobRes.json().catch(() => ({ message: blobRes.statusText }));
        throw new Error(`Blob ìƒì„± ì‹¤íŒ¨ (${blobRes.status}): ${errData.message}`);
      }
      const newBlob = await blobRes.json();

      // Step 2: Get the current branch reference
      const refRes = await fetch(`https://api.github.com/repos/${repo}/git/ref/heads/main`, {
        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (!refRes.ok) throw new Error('ë¸Œëœì¹˜ ì°¸ì¡°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      const refData = await refRes.json();
      const latestCommitSha = refData.object.sha;

      // Step 3: Get the current commit's tree
      const commitRes = await fetch(`https://api.github.com/repos/${repo}/git/commits/${latestCommitSha}`, {
        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (!commitRes.ok) throw new Error('ì»¤ë°‹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      const commitData = await commitRes.json();

      // Step 4: Create a new tree with the updated file
      const treeRes = await fetch(`https://api.github.com/repos/${repo}/git/trees`, {
        method: 'POST',
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          base_tree: commitData.tree.sha,
          tree: [{ path: 'data/items.json', mode: '100644', type: 'blob', sha: newBlob.sha }],
        }),
      });
      if (!treeRes.ok) throw new Error('íŠ¸ë¦¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      const newTree = await treeRes.json();

      // Step 5: Create a new commit
      const newCommitRes = await fetch(`https://api.github.com/repos/${repo}/git/commits`, {
        method: 'POST',
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: commitMessage,
          tree: newTree.sha,
          parents: [latestCommitSha],
        }),
      });
      if (!newCommitRes.ok) throw new Error('ì»¤ë°‹ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      const newCommit = await newCommitRes.json();

      // Step 6: Update the branch reference
      showStatus('4/4 main ë¸Œëœì¹˜ ë°˜ì˜ ì¤‘...', 'info');
      const updateRefRes = await fetch(`https://api.github.com/repos/${repo}/git/refs/heads/main`, {
        method: 'PATCH',
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sha: newCommit.sha }),
      });
      if (!updateRefRes.ok) {
        const errData = await updateRefRes.json().catch(() => ({ message: updateRefRes.statusText }));
        throw new Error(`ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (${updateRefRes.status}): ${errData.message}`);
      }

      const skippedMsg = skippedCount > 0 ? ` (${skippedCount}ê°œ ì¤‘ë³µ ê±´ë„ˆëœ€)` : '';
      const shortSha = (newCommit.sha || '').slice(0, 7);
      items.forEach(i => { submittedIds.add(i.id); existingIds.add(i.id); });
      parsedItems = [];
      renderPreview();
      clearInputFields();
      setSubmitLoading(false);

      // Start workflow polling
      showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ${skippedMsg} Â· ${shortSha}\nâ³ X í¬ìŠ¤íŒ… ì›Œí¬í”Œë¡œ ëŒ€ê¸° ì¤‘...`, 'info');
      startWorkflowTracking(repo, token, newCommit.sha, newItems.length);
    } catch (err: any) {
      showStatus(`ì˜¤ë¥˜: ${err.message}`, 'error');
      setSubmitLoading(false);
    }
  }

  // â”€â”€â”€ Workflow Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let pollTimer: ReturnType<typeof setTimeout> | null = null;
  let pollSessionId = 0;

  type WorkflowTrackingState = {
    repo: string;
    commitSha: string;
    startedAt: number;
    expectedReplies: number;
  };

  type LivePostProgress = {
    postingReply?: number;
    totalReplies?: number;
    postedReplies?: number;
    degraded?: boolean;
  };

  function saveWorkflowTracking(state: WorkflowTrackingState) {
    localStorage.setItem(WORKFLOW_TRACKING_KEY, JSON.stringify(state));
  }

  function loadWorkflowTracking(): WorkflowTrackingState | null {
    try {
      const raw = localStorage.getItem(WORKFLOW_TRACKING_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed?.repo || !parsed?.commitSha || !parsed?.startedAt) return null;
      return {
        repo: String(parsed.repo),
        commitSha: String(parsed.commitSha),
        startedAt: Number(parsed.startedAt),
        expectedReplies: Number(parsed.expectedReplies || 0),
      };
    } catch {
      return null;
    }
  }

  function clearWorkflowTracking() {
    localStorage.removeItem(WORKFLOW_TRACKING_KEY);
    hasActiveWorkflowTracking = false;
  }

  function startWorkflowTracking(repo: string, token: string, commitSha: string, expectedReplies: number, startedAt?: number) {
    const state: WorkflowTrackingState = {
      repo,
      commitSha,
      startedAt: startedAt || Date.now(),
      expectedReplies: Math.max(0, expectedReplies || 0),
    };
    hasActiveWorkflowTracking = true;
    saveWorkflowTracking(state);
    pollWorkflowStatus(repo, token, commitSha, state);
  }

  async function fetchPostJobProgress(repo: string, token: string, jobId: number): Promise<LivePostProgress | null> {
    const res = await fetch(`https://api.github.com/repos/${repo}/actions/jobs/${jobId}/logs`, {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!res.ok) {
      throw new Error(`log-fetch-${res.status}`);
    }

    const text = await res.text();
    if (!text) return null;

    const postingMatches = [...text.matchAll(/Posting reply (\d+)\/(\d+)\.\.\./g)];
    const postedMatches = [...text.matchAll(/Reply (\d+) posted:/g)];
    const totalFromComplete = text.match(/Thread complete: 1 main \+ (\d+) replies/);
    const degraded = /Thread degraded to main-only mode/.test(text);

    const latestPosting = postingMatches.length > 0 ? postingMatches[postingMatches.length - 1] : null;
    const latestPosted = postedMatches.length > 0 ? postedMatches[postedMatches.length - 1] : null;
    const postingReply = latestPosting ? Number(latestPosting[1]) : undefined;
    const totalReplies = latestPosting ? Number(latestPosting[2]) : (totalFromComplete ? Number(totalFromComplete[1]) : undefined);
    const postedReplies = latestPosted ? Number(latestPosted[1]) : undefined;

    return { postingReply, totalReplies, postedReplies, degraded };
  }

  async function pollWorkflowStatus(repo: string, token: string, commitSha: string, state?: WorkflowTrackingState) {
    const shortSha = commitSha.slice(0, 7);
    const POLL_INTERVAL = 5000;
    const MAX_POLLS = 96; // 8min max
    const trackingState: WorkflowTrackingState = state || {
      repo,
      commitSha,
      startedAt: Date.now(),
      expectedReplies: 0,
    };

    if (pollTimer) {
      clearTimeout(pollTimer);
      pollTimer = null;
    }
    pollSessionId += 1;
    const currentSession = pollSessionId;

    let polls = 0;
    let postStartedAt = 0;
    let liveProgress: LivePostProgress | null = null;
    let logFetchDisabled = false;
    let lastLogFetchAt = 0;

    const elapsedSeconds = () => Math.max(0, Math.floor((Date.now() - trackingState.startedAt) / 1000));
    const postElapsedSeconds = () => Math.max(0, Math.floor((Date.now() - postStartedAt) / 1000));
    const isCurrentSession = () => currentSession === pollSessionId;
    const scheduleNext = () => {
      if (!isCurrentSession()) return;
      pollTimer = setTimeout(poll, POLL_INTERVAL);
    };

    async function ghApi(endpoint: string) {
      const res = await fetch(`https://api.github.com/repos/${repo}/actions/${endpoint}`, {
        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (!res.ok) return null;
      return res.json();
    }

    async function maybeUpdateLiveProgress(postJobId?: number) {
      if (!postJobId || logFetchDisabled) return;
      const now = Date.now();
      if (now - lastLogFetchAt < 10000) return; // 10s ë§ˆë‹¤ ë¡œê·¸ íŒŒì‹±
      lastLogFetchAt = now;

      try {
        const progress = await fetchPostJobProgress(repo, token, postJobId);
        if (progress) liveProgress = progress;
      } catch (e: any) {
        const msg = String(e?.message || '');
        if (msg.includes('log-fetch-403') || msg.includes('log-fetch-404')) {
          // í† í° ê¶Œí•œ/ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ë¶ˆê°€ ì‹œ ê³¼ë„í•œ ì¬ì‹œë„ ì¤‘ë‹¨
          logFetchDisabled = true;
        }
      }
    }

    function buildPostProgressMessage() {
      if (liveProgress?.degraded) {
        return 'âš ï¸ reply ì°¨ë‹¨ ê°ì§€: main-only ì²˜ë¦¬ ì¤‘...';
      }

      const total = liveProgress?.totalReplies || trackingState.expectedReplies || 0;
      if (liveProgress?.postingReply && total > 0) {
        return `ğŸ¦ X reply ${liveProgress.postingReply}/${total} ê²Œì‹œ ì¤‘...`;
      }

      if (liveProgress?.postedReplies && total > 0) {
        const next = Math.min(total, liveProgress.postedReplies + 1);
        return `ğŸ¦ X reply ${next}/${total} ê²Œì‹œ ì¤€ë¹„ ì¤‘...`;
      }

      if (total > 0 && postStartedAt > 0) {
        const estimated = Math.min(total, Math.max(1, Math.floor(postElapsedSeconds() / 11) + 1));
        return `ğŸ¦ X ìŠ¤ë ˆë“œ ê²Œì‹œ ì¤‘... (reply ${estimated}/${total} ì˜ˆìƒ)`;
      }

      return 'ğŸ¦ X ìŠ¤ë ˆë“œ ê²Œì‹œ ì¤‘...';
    }

    async function poll() {
      if (!isCurrentSession()) return;
      polls++;

      if (polls > MAX_POLLS) {
        clearWorkflowTracking();
        showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ Â· ${shortSha}\nâš ï¸ ì›Œí¬í”Œë¡œ ìƒíƒœ í™•ì¸ ì‹œê°„ ì´ˆê³¼ â€” Actions í˜ì´ì§€ì—ì„œ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.`, 'warn');
        return;
      }

      if (polls % 6 === 0) {
        saveWorkflowTracking(trackingState);
      }

      try {
        const data = await ghApi(`runs?head_sha=${commitSha}&per_page=5`);
        if (!data?.workflow_runs?.length) {
          showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ Â· ${shortSha}\nâ³ ì›Œí¬í”Œë¡œ íŠ¸ë¦¬ê±° ëŒ€ê¸° ì¤‘... (${elapsedSeconds()}s)`, 'info');
          scheduleNext();
          return;
        }

        const run = data.workflow_runs.find((r: any) => r.name === 'Notify & Post to X') || data.workflow_runs[0];
        const runStatus = run.status;
        const runConclusion = run.conclusion;

        if (runStatus === 'completed') {
          clearWorkflowTracking();
          const jobsData = await ghApi(`runs/${run.id}/jobs`);
          const postJob = jobsData?.jobs?.find((j: any) => j.name === 'post_x');

          if (runConclusion === 'success') {
            if (postJob?.conclusion === 'success') {
              showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ Â· ${shortSha}\nâœ… X í¬ìŠ¤íŒ… ì„±ê³µ! ìŠ¤ë ˆë“œê°€ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
              fadeStatusAfter(7000);
            } else if (postJob?.conclusion === 'skipped') {
              showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ Â· ${shortSha}\nâ­ï¸ X í¬ìŠ¤íŒ… ê±´ë„ˆëœ€ (ENABLE_X_POST ë¯¸ì„¤ì • ë˜ëŠ” ìƒˆ í•­ëª© ì—†ìŒ)`, 'info');
              fadeStatusAfter(7000);
            } else {
              showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ Â· ${shortSha}\nâœ… ì›Œí¬í”Œë¡œ ì™„ë£Œ`, 'success');
              fadeStatusAfter(7000);
            }
          } else {
            const failMsg = postJob?.conclusion === 'failure'
              ? 'X í¬ìŠ¤íŒ… ì‹¤íŒ¨ â€” Actionsì—ì„œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
              : `ì›Œí¬í”Œë¡œ ${runConclusion || 'ì‹¤íŒ¨'}`;
            showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ Â· ${shortSha}\nâŒ ${failMsg}`, 'error');
          }
          return;
        }

        const jobsData = await ghApi(`runs/${run.id}/jobs`);
        const jobs = jobsData?.jobs || [];
        const activeJob = jobs.find((j: any) => j.status === 'in_progress');
        const activeStep = activeJob?.steps?.find((s: any) => s.status === 'in_progress');
        const postJob = jobs.find((j: any) => j.name === 'post_x');

        let progressMsg = '';
        if (activeJob?.name === 'prepare') {
          progressMsg = 'ğŸ“¦ ë°ì´í„° ì¤€ë¹„ ì¤‘...';
          if (activeStep?.name?.includes('Build digest')) progressMsg = 'ğŸ“¦ í¬ìŠ¤íŠ¸ ìƒì„± ì¤‘...';
          else if (activeStep?.name?.includes('Extract')) progressMsg = 'ğŸ“¦ ìƒˆ í•­ëª© ì¶”ì¶œ ì¤‘...';
        } else if (activeJob?.name === 'post_x') {
          if (!postStartedAt) postStartedAt = Date.now();
          await maybeUpdateLiveProgress(postJob?.id);
          progressMsg = buildPostProgressMessage();
        } else if (jobs.every((j: any) => j.status === 'queued')) {
          progressMsg = 'â³ ì›Œí¬í”Œë¡œ ì‹¤í–‰ ëŒ€ê¸° ì¤‘...';
        } else {
          progressMsg = `â³ ${runStatus}...`;
        }

        showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ Â· ${shortSha}\n${progressMsg} (${elapsedSeconds()}s)`, 'info');
        scheduleNext();
      } catch (e) {
        showStatus(`âœ… ì»¤ë°‹ ì™„ë£Œ Â· ${shortSha}\nâ³ ìƒíƒœ ì¬í™•ì¸ ì¤‘... (${elapsedSeconds()}s)`, 'info');
        scheduleNext();
      }
    }

    poll();
  }

  function fadeStatusAfter(ms: number) {
    setTimeout(() => {
      const statusEl = document.getElementById('submit-status');
      if (statusEl && !statusEl.classList.contains('hidden')) {
        statusEl.style.transition = 'opacity 0.3s';
        statusEl.style.opacity = '0';
        setTimeout(() => {
          statusEl.classList.add('hidden');
          statusEl.style.opacity = '';
          statusEl.style.transition = '';
        }, 300);
      }
    }, ms);
  }

  function showStatus(message: string, type: 'info' | 'success' | 'error' | 'warn', opts: { autoScroll?: boolean } = {}) {
    const el = document.getElementById('submit-status');
    if (!el) return;
    el.classList.remove('hidden');
    el.style.opacity = '1';
    el.style.transition = '';
    const colors: Record<string, string> = {
      info: 'bg-claude-50 dark:bg-claude-950/30 text-claude-700 dark:text-claude-300 border border-claude-200 dark:border-claude-800',
      success: 'bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800',
      error: 'bg-red-50 dark:bg-red-950/30 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800',
      warn: 'bg-amber-50 dark:bg-amber-950/30 text-amber-700 dark:text-amber-300 border border-amber-200 dark:border-amber-800',
    };
    el.className = `mb-5 p-4 rounded-xl text-sm whitespace-pre-line animate-fade-in ${colors[type]}`;
    el.textContent = message;

    if (opts.autoScroll) {
      el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function openConfirmModal() {
    const modal = document.getElementById('confirm-modal');
    const msgEl = document.getElementById('confirm-message');
    const listEl = document.getElementById('confirm-item-list');
    if (!modal || !msgEl) return;
    const repo = (document.getElementById('github-repo') as HTMLInputElement)?.value || 'chanmuzi/NLP-Paper-News';
    msgEl.innerHTML = `<span class="font-semibold">${parsedItems.length}ê°œ</span> í•­ëª©ì„ <span class="font-mono text-xs">${escapeHtml(repo)}</span>ì— ì¶”ê°€í•©ë‹ˆë‹¤.`;
    if (listEl) {
      listEl.innerHTML = parsedItems.map(item => {
        const icon = TYPE_ICONS[item.type] || 'ğŸ“œ';
        return `<div class="flex items-center gap-1.5"><span>${icon}</span><span class="truncate">${escapeHtml(item.title)}</span></div>`;
      }).join('');
    }
    modal.classList.remove('hidden');
  }

  function closeConfirmModal() {
    document.getElementById('confirm-modal')?.classList.add('hidden');
  }

  // â”€â”€â”€ Submit & Copy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('submit-btn')?.addEventListener('click', () => {
    if (parsedItems.length === 0) {
      showToast('ë¨¼ì € íŒŒì‹± ë˜ëŠ” ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.');
      return;
    }
    const token = localStorage.getItem('github_token');
    if (!token) {
      showStatus('GitHub í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒë‹¨ GitHub ë²„íŠ¼ì—ì„œ í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
      return;
    }
    pendingSubmitItems = [...parsedItems];
    openConfirmModal();
  });

  document.getElementById('confirm-submit')?.addEventListener('click', () => {
    closeConfirmModal();
    if (pendingSubmitItems.length > 0) {
      submitToGitHub(pendingSubmitItems);
      pendingSubmitItems = [];
    }
  });
  document.getElementById('confirm-cancel')?.addEventListener('click', closeConfirmModal);
  document.getElementById('confirm-backdrop')?.addEventListener('click', closeConfirmModal);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeConfirmModal();
  });

  document.getElementById('copy-json')?.addEventListener('click', () => {
    const jsonOutput = document.getElementById('json-output');
    if (jsonOutput) {
      navigator.clipboard.writeText(jsonOutput.textContent || '');
      showToast('JSONì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
  });

  // â”€â”€â”€ GitHub token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateTokenStatus() {
    const statusEl = document.getElementById('token-status');
    const token = localStorage.getItem('github_token');
    if (statusEl) {
      if (token) {
        statusEl.textContent = 'ì—°ê²°ë¨';
        statusEl.className = 'inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-xs bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400';
      } else {
        statusEl.textContent = 'ë¯¸ì—°ê²°';
        statusEl.className = 'inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-xs bg-gray-100 dark:bg-gray-800 text-gray-400';
      }
    }
  }

  document.getElementById('toggle-settings')?.addEventListener('click', () => {
    document.getElementById('settings-panel')?.classList.toggle('hidden');
  });
  document.getElementById('save-token')?.addEventListener('click', () => {
    const input = document.getElementById('github-token') as HTMLInputElement;
    if (input.value.trim()) {
      localStorage.setItem('github_token', input.value.trim());
      input.value = '';
      updateTokenStatus();
      loadExistingIds(); // Reload with new token
      showToast('í† í°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      resumeWorkflowTrackingIfNeeded();
    }
  });
  document.getElementById('clear-token')?.addEventListener('click', () => {
    localStorage.removeItem('github_token');
    updateTokenStatus();
    showToast('í† í°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  });

  function showToast(message: string) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function resumeWorkflowTrackingIfNeeded() {
    if (hasActiveWorkflowTracking) return;
    const state = loadWorkflowTracking();
    if (!state) return;

    // ì˜¤ë˜ëœ ì„¸ì…˜ì€ ìë™ íê¸° (2ì‹œê°„)
    if (Date.now() - state.startedAt > 2 * 60 * 60 * 1000) {
      clearWorkflowTracking();
      return;
    }

    const token = localStorage.getItem('github_token');
    if (!token) {
      showStatus('ì§„í–‰ ì¤‘ì´ë˜ ì›Œí¬í”Œë¡œ ì´ë ¥ì´ ìˆìŠµë‹ˆë‹¤. í† í°ì„ ë‹¤ì‹œ ì €ì¥í•˜ë©´ ìƒíƒœë¥¼ ë³µêµ¬í•©ë‹ˆë‹¤.', 'warn');
      return;
    }

    showStatus(`ğŸ”„ ì´ì „ ì›Œí¬í”Œë¡œ ìƒíƒœ ë³µêµ¬ ì¤‘... Â· ${state.commitSha.slice(0, 7)}`, 'info');
    startWorkflowTracking(state.repo, token, state.commitSha, state.expectedReplies, state.startedAt);
  }

  window.addEventListener('beforeunload', (e) => {
    if (!hasActiveWorkflowTracking) return;
    e.preventDefault();
    e.returnValue = '';
  });

  // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  updateTokenStatus();
  const savedRepo = localStorage.getItem('github_repo');
  if (savedRepo) {
    (document.getElementById('github-repo') as HTMLInputElement).value = savedRepo;
  }
  loadExistingIds(); // Load after repo value is restored
  document.getElementById('github-repo')?.addEventListener('change', (e) => {
    localStorage.setItem('github_repo', (e.target as HTMLInputElement).value);
    loadExistingIds(); // Reload for new repo
  });
  resumeWorkflowTrackingIfNeeded();
</script>
