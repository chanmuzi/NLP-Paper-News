---
interface Bullet {
  text: string;
  level: number;
}

interface Props {
  id: string;
  type: string;
  org: string;
  title: string;
  url: string;
  bullets: Bullet[];
  date: string;
  year?: string;
  month?: string;
  week?: string;
  tags?: string[];
  showWeek?: boolean;
}

const { id, type, org, title, url, bullets, date, year, month, week, tags = [], showWeek = false } = Astro.props;

const typeInfo: Record<string, { icon: string; label: string; color: string; bgLight: string; bgDark: string; accent: string }> = {
  paper: {
    icon: 'üìú',
    label: 'Paper',
    color: 'text-claude-800 dark:text-claude-300',
    bgLight: 'bg-white border-claude-200/60 shadow-card',
    bgDark: 'dark:bg-anthro-darkSurface dark:border-claude-800/40 dark:shadow-card-dark',
    accent: 'bg-claude-500',
  },
  dev: {
    icon: 'üßëüèª‚Äçüíª',
    label: 'Dev',
    color: 'text-amber-800 dark:text-amber-300',
    bgLight: 'bg-white border-amber-200/60 shadow-card',
    bgDark: 'dark:bg-anthro-darkSurface dark:border-amber-800/40 dark:shadow-card-dark',
    accent: 'bg-amber-600',
  },
  news: {
    icon: 'üóûÔ∏è',
    label: 'News',
    color: 'text-stone-700 dark:text-stone-300',
    bgLight: 'bg-white border-stone-200/60 shadow-card',
    bgDark: 'dark:bg-anthro-darkSurface dark:border-stone-700/40 dark:shadow-card-dark',
    accent: 'bg-stone-500',
  },
};

const info = typeInfo[type] || typeInfo.paper;
const weekLabel = week ? `${week}Ï£ºÏ∞®` : '';
const dateDisplay = showWeek && year && month ? `${year}.${String(month).padStart(2, '0')} ${weekLabel}` : '';
const hasMoreBullets = bullets.length > 3;
---

<article
  class={`item-card group relative flex flex-col rounded-xl border transition-all duration-200 hover:shadow-card-hover dark:hover:shadow-card-dark-hover hover:-translate-y-0.5 ${info.bgLight} ${info.bgDark}`}
  data-type={type}
  data-org={org.toLowerCase()}
  data-title={title.toLowerCase()}
  data-id={id}
>
  <div class={`absolute top-0 left-0 w-1 h-full rounded-l-xl ${info.accent}`}></div>

  <div class="pl-5 pr-4 py-4 flex-1 flex flex-col">
    <div class="flex items-center justify-between gap-2 mb-2">
      <div class="flex items-center gap-2 min-w-0">
        <span class={`inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-xs font-bold ${info.color} bg-gray-50 dark:bg-white/5`}>
          {info.icon} {info.label}
        </span>
        <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-md truncate">
          {org}
        </span>
      </div>
      {dateDisplay && (
        <span class="text-xs text-gray-400 dark:text-gray-500 font-mono flex-shrink-0">
          {dateDisplay}
        </span>
      )}
    </div>

    {url ? (
      <a
        href={url}
        target="_blank"
        rel="noopener noreferrer"
        class="block text-[15px] font-bold text-gray-900 dark:text-gray-100 hover:text-claude-600 dark:hover:text-claude-400 transition-colors mb-2 leading-snug"
      >
        {title}
        <svg class="inline-block w-3.5 h-3.5 ml-1 opacity-0 group-hover:opacity-50 transition-opacity -translate-y-px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
      </a>
    ) : (
      <h3 class="text-[15px] font-bold text-gray-900 dark:text-gray-100 mb-2 leading-snug">
        {title}
      </h3>
    )}

    {bullets.length > 0 && (
      <div class="bullets-container">
        <ul class="space-y-1 text-[13px] leading-relaxed">
          {bullets.slice(0, 3).map((bullet) => (
            <li class={`flex items-start gap-2 ${bullet.level > 1 ? 'ml-4 text-gray-500 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300'}`}>
              <span class={`mt-[7px] w-1 h-1 rounded-full flex-shrink-0 ${bullet.level > 1 ? 'bg-gray-400 dark:bg-gray-600' : info.accent}`}></span>
              <span>{bullet.text}</span>
            </li>
          ))}
        </ul>
        {hasMoreBullets && (
          <div class="bullets-extra hidden">
            <ul class="space-y-1 text-[13px] leading-relaxed mt-1">
              {bullets.slice(3).map((bullet) => (
                <li class={`flex items-start gap-2 ${bullet.level > 1 ? 'ml-4 text-gray-500 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300'}`}>
                  <span class={`mt-[7px] w-1 h-1 rounded-full flex-shrink-0 ${bullet.level > 1 ? 'bg-gray-400 dark:bg-gray-600' : info.accent}`}></span>
                  <span>{bullet.text}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    )}

    <div class="flex items-center justify-between mt-auto pt-2 border-t border-gray-100 dark:border-gray-800/50">
      <div>
        {hasMoreBullets && (
          <button
            class="expand-btn text-xs font-medium text-claude-600 hover:text-claude-700 dark:text-claude-400 dark:hover:text-claude-300 transition-colors"
            data-id={id}
          >
            +{bullets.length - 3}Í∞ú Îçî Î≥¥Í∏∞
          </button>
        )}
      </div>
      <div class="flex items-center gap-0.5">
        <button
          class="bookmark-btn p-1.5 rounded-md text-gray-300 hover:text-claude-500 dark:text-gray-600 dark:hover:text-claude-400 transition-colors"
          data-id={id}
          title="Î∂ÅÎßàÌÅ¨"
        >
          <svg class="w-4 h-4 bookmark-icon-empty" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
          <svg class="w-4 h-4 bookmark-icon-filled hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
        </button>
        <button
          class="share-btn p-1.5 rounded-md text-gray-300 hover:text-claude-500 dark:text-gray-600 dark:hover:text-claude-400 transition-colors"
          data-title={title}
          data-url={url}
          data-org={org}
          title="Í≥µÏú†"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <button
          class="delete-btn hidden p-1.5 rounded-md text-gray-300 hover:text-red-500 dark:text-gray-600 dark:hover:text-red-400 transition-colors"
          data-id={id}
          data-title={title}
          title="ÏÇ≠Ï†ú"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </button>
      </div>
    </div>
  </div>
</article>

<script>
  document.querySelectorAll('.expand-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.item-card');
      const extra = card?.querySelector('.bullets-extra');
      if (!extra) return;
      const isHidden = extra.classList.contains('hidden');
      extra.classList.toggle('hidden');
      btn.textContent = isHidden ? 'Ï†ëÍ∏∞' : `+${extra.querySelectorAll('li').length}Í∞ú Îçî Î≥¥Í∏∞`;
    });
  });

  function getBookmarks(): string[] {
    try { return JSON.parse(localStorage.getItem('bookmarks') || '[]'); } catch { return []; }
  }

  function updateBookmarkUI(btn: Element, isBookmarked: boolean) {
    const empty = btn.querySelector('.bookmark-icon-empty');
    const filled = btn.querySelector('.bookmark-icon-filled');
    if (isBookmarked) {
      empty?.classList.add('hidden');
      filled?.classList.remove('hidden');
      btn.classList.add('text-claude-500', 'dark:text-claude-400');
      btn.classList.remove('text-gray-300', 'dark:text-gray-600');
    } else {
      empty?.classList.remove('hidden');
      filled?.classList.add('hidden');
      btn.classList.remove('text-claude-500', 'dark:text-claude-400');
      btn.classList.add('text-gray-300', 'dark:text-gray-600');
    }
  }

  const bookmarks = getBookmarks();
  document.querySelectorAll('.bookmark-btn').forEach((btn) => {
    const id = (btn as HTMLElement).dataset.id || '';
    if (bookmarks.includes(id)) updateBookmarkUI(btn, true);

    btn.addEventListener('click', () => {
      const cur = getBookmarks();
      const itemId = (btn as HTMLElement).dataset.id || '';
      const idx = cur.indexOf(itemId);
      if (idx >= 0) {
        cur.splice(idx, 1);
        updateBookmarkUI(btn, false);
        showToast('Î∂ÅÎßàÌÅ¨ÏóêÏÑú Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§');
      } else {
        cur.push(itemId);
        updateBookmarkUI(btn, true);
        showToast('Î∂ÅÎßàÌÅ¨Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
      }
      localStorage.setItem('bookmarks', JSON.stringify(cur));
    });
  });

  document.querySelectorAll('.share-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const el = btn as HTMLElement;
      const title = el.dataset.title || '';
      const url = el.dataset.url || '';
      const org = el.dataset.org || '';
      const text = `${title} (${org})`;
      if (navigator.share) {
        navigator.share({ title: text, url }).catch(() => {});
      } else {
        navigator.clipboard.writeText(`${text}\n${url}`).then(() => showToast('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§'));
      }
    });
  });

  // Delete buttons: show only when GitHub token exists
  if (localStorage.getItem('github_token')) {
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.classList.remove('hidden');
      btn.addEventListener('click', async () => {
        const el = btn as HTMLElement;
        const itemId = el.dataset.id || '';
        const itemTitle = el.dataset.title || '';
        if (!confirm(`"${itemTitle}" Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

        const token = localStorage.getItem('github_token')!;
        const repo = localStorage.getItem('github_repo') || 'chanmuzi/NLP-Paper-News';
        const headers: Record<string, string> = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' };
        const postHeaders = { ...headers, 'Content-Type': 'application/json' };

        showToast('ÏÇ≠Ï†ú Ï≤òÎ¶¨ Ï§ë...');
        try {
          const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/data/items.json`, { headers });
          if (!getRes.ok) throw new Error(`GitHub API Ïò§Î•ò (${getRes.status})`);
          const fileData = await getRes.json();

          let base64Content: string;
          if (fileData.content) {
            base64Content = fileData.content.replace(/\n/g, '');
          } else {
            const blobRes = await fetch(`https://api.github.com/repos/${repo}/git/blobs/${fileData.sha}`, { headers });
            if (!blobRes.ok) throw new Error('Blob API Ïò§Î•ò');
            base64Content = (await blobRes.json()).content.replace(/\n/g, '');
          }
          const bin = atob(base64Content);
          const bytes = new Uint8Array(bin.length);
          for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
          const currentContent = JSON.parse(new TextDecoder('utf-8').decode(bytes));

          const beforeCount = currentContent.items.length;
          currentContent.items = currentContent.items.filter((i: any) => i.id !== itemId);
          if (currentContent.items.length === beforeCount) { showToast('Ìï¥Îãπ Ìï≠Î™©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§'); return; }

          currentContent.total_items = currentContent.items.length;
          currentContent.last_updated = new Date().toISOString();
          currentContent.stats = {
            total: currentContent.items.length,
            paper: currentContent.items.filter((i: any) => i.type === 'paper').length,
            dev: currentContent.items.filter((i: any) => i.type === 'dev').length,
            news: currentContent.items.filter((i: any) => i.type === 'news').length,
          };

          const uint8 = new TextEncoder().encode(JSON.stringify(currentContent, null, 2));
          let binary = '';
          for (let i = 0; i < uint8.length; i++) binary += String.fromCharCode(uint8[i]);
          const newBase64 = btoa(binary);

          const blobRes = await fetch(`https://api.github.com/repos/${repo}/git/blobs`, {
            method: 'POST', headers: postHeaders,
            body: JSON.stringify({ content: newBase64, encoding: 'base64' }),
          });
          if (!blobRes.ok) throw new Error('Blob ÏÉùÏÑ± Ïã§Ìå®');
          const newBlob = await blobRes.json();

          const refRes = await fetch(`https://api.github.com/repos/${repo}/git/ref/heads/main`, { headers });
          if (!refRes.ok) throw new Error('Î∏åÎûúÏπò Ï∞∏Ï°∞ Ïã§Ìå®');
          const latestSha = (await refRes.json()).object.sha;

          const commitRes = await fetch(`https://api.github.com/repos/${repo}/git/commits/${latestSha}`, { headers });
          if (!commitRes.ok) throw new Error('Ïª§Î∞ã Ï†ïÎ≥¥ Ïã§Ìå®');
          const treeSha = (await commitRes.json()).tree.sha;

          const treeRes = await fetch(`https://api.github.com/repos/${repo}/git/trees`, {
            method: 'POST', headers: postHeaders,
            body: JSON.stringify({ base_tree: treeSha, tree: [{ path: 'data/items.json', mode: '100644', type: 'blob', sha: newBlob.sha }] }),
          });
          if (!treeRes.ok) throw new Error('Ìä∏Î¶¨ ÏÉùÏÑ± Ïã§Ìå®');

          const newCommitRes = await fetch(`https://api.github.com/repos/${repo}/git/commits`, {
            method: 'POST', headers: postHeaders,
            body: JSON.stringify({ message: `Delete item: ${itemTitle}`, tree: (await treeRes.json()).sha, parents: [latestSha] }),
          });
          if (!newCommitRes.ok) throw new Error('Ïª§Î∞ã ÏÉùÏÑ± Ïã§Ìå®');

          const updateRes = await fetch(`https://api.github.com/repos/${repo}/git/refs/heads/main`, {
            method: 'PATCH', headers: postHeaders,
            body: JSON.stringify({ sha: (await newCommitRes.json()).sha }),
          });
          if (!updateRes.ok) throw new Error('Î∏åÎûúÏπò ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');

          const card = btn.closest('.item-card');
          if (card) card.remove();
          showToast(`"${itemTitle}" Ìï≠Î™©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§`);
        } catch (err: any) {
          showToast(`ÏÇ≠Ï†ú Ïã§Ìå®: ${err.message}`);
        }
      });
    });
  }

  function showToast(message: string) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
</script>
